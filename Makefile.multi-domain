# Makefile for Multi-Domain Deployment
# Optimized for Cloud Server: 1 Core, 1GB RAM, 5GB Storage

.PHONY: help start-all start-rausach start-tazagroup stop-all stop-rausach stop-tazagroup \
        logs logs-rausach logs-tazagroup status restart build clean \
        backup-rausach backup-tazagroup restore-rausach restore-tazagroup \
        setup-swap optimize-server

COMPOSE_FILE := docker-compose.multi-domain.yml

# Auto-detect docker compose command
DOCKER_COMPOSE := $(shell which docker-compose 2>/dev/null)
ifeq ($(DOCKER_COMPOSE),)
    DOCKER_COMPOSE := docker compose
endif

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

help: ## Hi·ªÉn th·ªã menu tr·ª£ gi√∫p
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BLUE)  Multi-Domain Deployment Commands (1C/1GB/5GB)$(NC)"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(YELLOW)üöÄ Start Commands:$(NC)"
	@echo "  make start-all        - Kh·ªüi ƒë·ªông T·∫§T C·∫¢ services (c·∫£ 2 domain)"
	@echo "  make start-rausach    - Kh·ªüi ƒë·ªông ch·ªâ domain Rausach (12xxx)"
	@echo "  make start-tazagroup  - Kh·ªüi ƒë·ªông ch·ªâ domain Tazagroup (13xxx)"
	@echo ""
	@echo "$(YELLOW)üõë Stop Commands:$(NC)"
	@echo "  make stop-all         - D·ª´ng T·∫§T C·∫¢ services"
	@echo "  make stop-rausach     - D·ª´ng ch·ªâ domain Rausach"
	@echo "  make stop-tazagroup   - D·ª´ng ch·ªâ domain Tazagroup"
	@echo ""
	@echo "$(YELLOW)üìã Management Commands:$(NC)"
	@echo "  make logs             - Xem logs t·∫•t c·∫£ services"
	@echo "  make logs-rausach     - Xem logs domain Rausach"
	@echo "  make logs-tazagroup   - Xem logs domain Tazagroup"
	@echo "  make status           - Xem tr·∫°ng th√°i v√† resource usage"
	@echo "  make restart          - Kh·ªüi ƒë·ªông l·∫°i t·∫•t c·∫£ services"
	@echo "  make build            - Build l·∫°i images"
	@echo "  make clean            - D·ªçn d·∫πp v√† x√≥a volumes"
	@echo ""
	@echo "$(YELLOW)üíæ Backup/Restore Commands:$(NC)"
	@echo "  make backup-rausach   - Backup database Rausach"
	@echo "  make backup-tazagroup - Backup database Tazagroup"
	@echo "  make restore-rausach  - Restore database Rausach"
	@echo "  make restore-tazagroup - Restore database Tazagroup"
	@echo ""
	@echo "$(YELLOW)‚öôÔ∏è  Server Setup Commands:$(NC)"
	@echo "  make setup-swap       - T·∫°o swap file 2GB"
	@echo "  make optimize-server  - T·ªëi ∆∞u kernel parameters"
	@echo ""

# Start Commands
start-all: ## Kh·ªüi ƒë·ªông t·∫•t c·∫£ services
	@echo "$(GREEN)üöÄ Starting ALL services (2 domains)...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) up -d
	@$(MAKE) status

start-rausach: ## Kh·ªüi ƒë·ªông domain Rausach
	@echo "$(GREEN)üöÄ Starting Rausach domain (12xxx)...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) up -d postgres redis minio rausach-backend rausach-frontend
	@$(MAKE) status

start-tazagroup: ## Kh·ªüi ƒë·ªông domain Tazagroup
	@echo "$(GREEN)üöÄ Starting Tazagroup domain (13xxx)...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) up -d postgres redis minio tazagroup-backend tazagroup-frontend
	@$(MAKE) status

# Stop Commands
stop-all: ## D·ª´ng t·∫•t c·∫£ services
	@echo "$(YELLOW)üõë Stopping ALL services...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) down
	@echo "$(GREEN)‚úÖ All services stopped$(NC)"

stop-rausach: ## D·ª´ng domain Rausach
	@echo "$(YELLOW)üõë Stopping Rausach domain...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) stop rausach-backend rausach-frontend
	@echo "$(GREEN)‚úÖ Rausach stopped$(NC)"

stop-tazagroup: ## D·ª´ng domain Tazagroup
	@echo "$(YELLOW)üõë Stopping Tazagroup domain...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) stop tazagroup-backend tazagroup-frontend
	@echo "$(GREEN)‚úÖ Tazagroup stopped$(NC)"

# Log Commands
logs: ## Xem logs t·∫•t c·∫£
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) logs -f --tail=100

logs-rausach: ## Xem logs Rausach
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) logs -f --tail=100 rausach-backend rausach-frontend

logs-tazagroup: ## Xem logs Tazagroup
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) logs -f --tail=100 tazagroup-backend tazagroup-frontend

# Status & Management
status: ## Xem tr·∫°ng th√°i services
	@echo ""
	@echo "$(BLUE)üìä Container Status:$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) ps
	@echo ""
	@echo "$(BLUE)üíæ Resource Usage:$(NC)"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" $$($(DOCKER_COMPOSE) -f $(COMPOSE_FILE) ps -q 2>/dev/null) 2>/dev/null || echo "No containers running"
	@echo ""
	@echo "$(GREEN)üåê Access URLs:$(NC)"
	@echo "  $(YELLOW)Rausach:$(NC)"
	@echo "    - Frontend:  http://116.118.49.243:12000"
	@echo "    - Backend:   http://116.118.49.243:12001/graphql"
	@echo ""
	@echo "  $(YELLOW)Tazagroup:$(NC)"
	@echo "    - Frontend:  http://116.118.49.243:13000"
	@echo "    - Backend:   http://116.118.49.243:13001/graphql"
	@echo ""
	@echo "  $(YELLOW)Shared:$(NC)"
	@echo "    - Minio:     http://116.118.49.243:12008"
	@echo ""

restart: ## Kh·ªüi ƒë·ªông l·∫°i t·∫•t c·∫£
	@echo "$(YELLOW)üîÑ Restarting all services...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) restart
	@$(MAKE) status

build: ## Build l·∫°i images
	@echo "$(YELLOW)üî® Building images...$(NC)"
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) build --no-cache
	@echo "$(GREEN)‚úÖ Build complete$(NC)"

clean: ## D·ªçn d·∫πp v√† x√≥a volumes
	@echo "$(RED)üóëÔ∏è  Cleaning up (volumes will be REMOVED!)$(NC)"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) down -v
	@docker system prune -f
	@echo "$(GREEN)‚úÖ Cleanup complete$(NC)"

# Backup & Restore
BACKUP_DIR := ./backups
DATE := $(shell date +%Y%m%d_%H%M%S)

backup-rausach: ## Backup database Rausach
	@echo "$(YELLOW)üíæ Backing up Rausach database...$(NC)"
	@mkdir -p $(BACKUP_DIR)
	@docker exec shared-postgres pg_dump -U postgres rausachcore > $(BACKUP_DIR)/rausach_$(DATE).sql
	@echo "$(GREEN)‚úÖ Backup saved: $(BACKUP_DIR)/rausach_$(DATE).sql$(NC)"

backup-tazagroup: ## Backup database Tazagroup
	@echo "$(YELLOW)üíæ Backing up Tazagroup database...$(NC)"
	@mkdir -p $(BACKUP_DIR)
	@docker exec shared-postgres pg_dump -U postgres tazagroupcore > $(BACKUP_DIR)/tazagroup_$(DATE).sql
	@echo "$(GREEN)‚úÖ Backup saved: $(BACKUP_DIR)/tazagroup_$(DATE).sql$(NC)"

restore-rausach: ## Restore database Rausach (requires BACKUP_FILE=path)
	@echo "$(YELLOW)üì• Restoring Rausach database...$(NC)"
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "$(RED)‚ùå Error: Please specify BACKUP_FILE=path$(NC)"; \
		echo "Example: make restore-rausach BACKUP_FILE=./backups/rausach_20250103.sql"; \
		exit 1; \
	fi
	@docker exec -i shared-postgres psql -U postgres rausachcore < $(BACKUP_FILE)
	@echo "$(GREEN)‚úÖ Restore complete$(NC)"

restore-tazagroup: ## Restore database Tazagroup (requires BACKUP_FILE=path)
	@echo "$(YELLOW)üì• Restoring Tazagroup database...$(NC)"
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "$(RED)‚ùå Error: Please specify BACKUP_FILE=path$(NC)"; \
		echo "Example: make restore-tazagroup BACKUP_FILE=./backups/tazagroup_20250103.sql"; \
		exit 1; \
	fi
	@docker exec -i shared-postgres psql -U postgres tazagroupcore < $(BACKUP_FILE)
	@echo "$(GREEN)‚úÖ Restore complete$(NC)"

# Server Setup
setup-swap: ## T·∫°o swap file 2GB
	@echo "$(YELLOW)üîß Creating 2GB swap file...$(NC)"
	@sudo fallocate -l 2G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
	@sudo chmod 600 /swapfile
	@sudo mkswap /swapfile
	@sudo swapon /swapfile
	@echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
	@free -h
	@echo "$(GREEN)‚úÖ Swap created$(NC)"

optimize-server: ## T·ªëi ∆∞u kernel parameters
	@echo "$(YELLOW)‚öôÔ∏è  Optimizing kernel parameters...$(NC)"
	@echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
	@echo 'vm.vfs_cache_pressure=50' | sudo tee -a /etc/sysctl.conf
	@echo 'net.core.somaxconn=1024' | sudo tee -a /etc/sysctl.conf
	@sudo sysctl -p
	@echo "$(GREEN)‚úÖ Server optimized$(NC)"

# Quick commands
up: start-all ## Alias for start-all
down: stop-all ## Alias for stop-all
ps: status ## Alias for status

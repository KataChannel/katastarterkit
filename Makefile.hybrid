# Makefile for Hybrid Multi-Domain Deployment
# Database ri√™ng bi·ªát, Redis & Minio shared
# Optimized for: 1-2 Core, 1.5GB RAM, 7GB Storage

.PHONY: help start-all start-rausach start-tazagroup start-shared \
        stop-all stop-rausach stop-tazagroup \
        logs logs-rausach logs-tazagroup status restart build clean \
        backup-rausach backup-tazagroup restore-rausach restore-tazagroup

COMPOSE_FILE := docker-compose.hybrid.yml

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

help: ## Show help menu
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BLUE)  Hybrid Multi-Domain Commands (1-2C/1.5GB/7GB)$(NC)"
	@echo "$(BLUE)  Database: Dedicated | Redis & Minio: Shared$(NC)"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(YELLOW)üöÄ Start Commands:$(NC)"
	@echo "  make start-all        - Kh·ªüi ƒë·ªông T·∫§T C·∫¢ (c·∫£ 2 domain)"
	@echo "  make start-rausach    - Kh·ªüi ƒë·ªông ch·ªâ Rausach"
	@echo "  make start-tazagroup  - Kh·ªüi ƒë·ªông ch·ªâ Tazagroup"
	@echo "  make start-shared     - Kh·ªüi ƒë·ªông ch·ªâ Redis + Minio"
	@echo ""
	@echo "$(YELLOW)üõë Stop Commands:$(NC)"
	@echo "  make stop-all         - D·ª´ng T·∫§T C·∫¢"
	@echo "  make stop-rausach     - D·ª´ng Rausach"
	@echo "  make stop-tazagroup   - D·ª´ng Tazagroup"
	@echo ""
	@echo "$(YELLOW)üìã Management:$(NC)"
	@echo "  make logs             - Xem logs t·∫•t c·∫£"
	@echo "  make logs-rausach     - Xem logs Rausach"
	@echo "  make logs-tazagroup   - Xem logs Tazagroup"
	@echo "  make status           - Tr·∫°ng th√°i v√† resource usage"
	@echo "  make restart          - Restart t·∫•t c·∫£"
	@echo "  make build            - Build l·∫°i images"
	@echo "  make clean            - D·ªçn d·∫πp v√† x√≥a volumes"
	@echo ""
	@echo "$(YELLOW)üíæ Backup/Restore:$(NC)"
	@echo "  make backup-rausach   - Backup database Rausach"
	@echo "  make backup-tazagroup - Backup database Tazagroup"
	@echo "  make restore-rausach BACKUP_FILE=path  - Restore Rausach"
	@echo "  make restore-tazagroup BACKUP_FILE=path - Restore Tazagroup"
	@echo ""

# Start Commands
start-all: ## Kh·ªüi ƒë·ªông t·∫•t c·∫£
	@echo "$(GREEN)üöÄ Starting ALL services...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d
	@$(MAKE) status

start-rausach: ## Kh·ªüi ƒë·ªông Rausach
	@echo "$(GREEN)üöÄ Starting Rausach domain...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d redis minio rausach-postgres rausach-backend rausach-frontend
	@$(MAKE) status

start-tazagroup: ## Kh·ªüi ƒë·ªông Tazagroup
	@echo "$(GREEN)üöÄ Starting Tazagroup domain...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d redis minio tazagroup-postgres tazagroup-backend tazagroup-frontend
	@$(MAKE) status

start-shared: ## Kh·ªüi ƒë·ªông shared services
	@echo "$(GREEN)üöÄ Starting shared services (Redis + Minio)...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d redis minio
	@$(MAKE) status

# Stop Commands
stop-all: ## D·ª´ng t·∫•t c·∫£
	@echo "$(YELLOW)üõë Stopping ALL...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down
	@echo "$(GREEN)‚úÖ Stopped$(NC)"

stop-rausach: ## D·ª´ng Rausach
	@echo "$(YELLOW)üõë Stopping Rausach...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) stop rausach-postgres rausach-backend rausach-frontend
	@echo "$(GREEN)‚úÖ Stopped$(NC)"

stop-tazagroup: ## D·ª´ng Tazagroup
	@echo "$(YELLOW)üõë Stopping Tazagroup...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) stop tazagroup-postgres tazagroup-backend tazagroup-frontend
	@echo "$(GREEN)‚úÖ Stopped$(NC)"

# Logs
logs: ## Xem logs t·∫•t c·∫£
	@docker-compose -f $(COMPOSE_FILE) logs -f --tail=100

logs-rausach: ## Xem logs Rausach
	@docker-compose -f $(COMPOSE_FILE) logs -f --tail=100 rausach-postgres rausach-backend rausach-frontend

logs-tazagroup: ## Xem logs Tazagroup
	@docker-compose -f $(COMPOSE_FILE) logs -f --tail=100 tazagroup-postgres tazagroup-backend tazagroup-frontend

# Status
status: ## Tr·∫°ng th√°i
	@echo ""
	@echo "$(BLUE)üìä Container Status:$(NC)"
	@docker-compose -f $(COMPOSE_FILE) ps
	@echo ""
	@echo "$(BLUE)üíæ Resource Usage:$(NC)"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" $$(docker-compose -f $(COMPOSE_FILE) ps -q 2>/dev/null) 2>/dev/null || echo "No containers"
	@echo ""
	@echo "$(GREEN)üåê URLs:$(NC)"
	@echo "  $(YELLOW)Rausach:$(NC)"
	@echo "    Frontend:  http://116.118.49.243:12000"
	@echo "    Backend:   http://116.118.49.243:12001/graphql"
	@echo "    Database:  116.118.49.243:12003"
	@echo ""
	@echo "  $(YELLOW)Tazagroup:$(NC)"
	@echo "    Frontend:  http://116.118.49.243:13000"
	@echo "    Backend:   http://116.118.49.243:13001/graphql"
	@echo "    Database:  116.118.49.243:13003"
	@echo ""
	@echo "  $(YELLOW)Shared:$(NC)"
	@echo "    Minio:     http://116.118.49.243:12008"
	@echo "    Redis:     116.118.49.243:12004"
	@echo ""

restart: ## Restart t·∫•t c·∫£
	@echo "$(YELLOW)üîÑ Restarting...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) restart
	@$(MAKE) status

build: ## Build l·∫°i
	@echo "$(YELLOW)üî® Building...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) build --no-cache
	@echo "$(GREEN)‚úÖ Done$(NC)"

clean: ## D·ªçn d·∫πp
	@echo "$(RED)üóëÔ∏è  Cleaning (volumes will be REMOVED!)$(NC)"
	@read -p "Sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@docker-compose -f $(COMPOSE_FILE) down -v
	@docker system prune -f
	@echo "$(GREEN)‚úÖ Done$(NC)"

# Backup
BACKUP_DIR := ./backups
DATE := $(shell date +%Y%m%d_%H%M%S)

backup-rausach: ## Backup Rausach DB
	@echo "$(YELLOW)üíæ Backing up Rausach...$(NC)"
	@mkdir -p $(BACKUP_DIR)
	@docker exec rausach-postgres pg_dump -U postgres rausachcore > $(BACKUP_DIR)/rausach_$(DATE).sql
	@echo "$(GREEN)‚úÖ Saved: $(BACKUP_DIR)/rausach_$(DATE).sql$(NC)"

backup-tazagroup: ## Backup Tazagroup DB
	@echo "$(YELLOW)üíæ Backing up Tazagroup...$(NC)"
	@mkdir -p $(BACKUP_DIR)
	@docker exec tazagroup-postgres pg_dump -U postgres tazagroupcore > $(BACKUP_DIR)/tazagroup_$(DATE).sql
	@echo "$(GREEN)‚úÖ Saved: $(BACKUP_DIR)/tazagroup_$(DATE).sql$(NC)"

restore-rausach: ## Restore Rausach DB
	@echo "$(YELLOW)üì• Restoring Rausach...$(NC)"
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "$(RED)‚ùå Error: BACKUP_FILE required$(NC)"; \
		echo "Example: make restore-rausach BACKUP_FILE=./backups/rausach_20250103.sql"; \
		exit 1; \
	fi
	@docker exec -i rausach-postgres psql -U postgres rausachcore < $(BACKUP_FILE)
	@echo "$(GREEN)‚úÖ Done$(NC)"

restore-tazagroup: ## Restore Tazagroup DB
	@echo "$(YELLOW)üì• Restoring Tazagroup...$(NC)"
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "$(RED)‚ùå Error: BACKUP_FILE required$(NC)"; \
		echo "Example: make restore-tazagroup BACKUP_FILE=./backups/tazagroup_20250103.sql"; \
		exit 1; \
	fi
	@docker exec -i tazagroup-postgres psql -U postgres tazagroupcore < $(BACKUP_FILE)
	@echo "$(GREEN)‚úÖ Done$(NC)"

# Aliases
up: start-all
down: stop-all
ps: status

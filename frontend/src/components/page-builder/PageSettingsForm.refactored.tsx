/**
 * Updated PageSettingsForm v·ªõi integration m·ªõi
 * Refactored theo Clean Architecture
 */

'use client';

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Switch } from '@/components/ui/switch';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { AlertCircle, CheckCircle, Lock } from 'lucide-react';
import { Page, PageStatus, DynamicConfig } from '@/types/page-builder';
import { DynamicPageConfig } from './DynamicPageConfig';
import { PageLayoutSettings } from '@/features/page-builder/components/PageLayoutSettings';
import { usePageLayout } from '@/features/page-builder/hooks/usePageLayout';

/**
 * Vietnamese character transliteration map
 */
const VIETNAMESE_CHAR_MAP: Record<string, string> = {
  '√†': 'a', '√°': 'a', '·∫£': 'a', '√£': 'a', '·∫°': 'a',
  'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫≥': 'a', '·∫µ': 'a', '·∫∑': 'a',
  '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫©': 'a', '·∫´': 'a', '·∫≠': 'a',
  'ƒë': 'd',
  '√®': 'e', '√©': 'e', '·∫ª': 'e', '·∫Ω': 'e', '·∫π': 'e',
  '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªÉ': 'e', '·ªÖ': 'e', '·ªá': 'e',
  '√¨': 'i', '√≠': 'i', '·ªâ': 'i', 'ƒ©': 'i', '·ªã': 'i',
  '√≤': 'o', '√≥': 'o', '·ªè': 'o', '√µ': 'o', '·ªç': 'o',
  '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªï': 'o', '·ªó': 'o', '·ªô': 'o',
  '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ªü': 'o', '·ª°': 'o', '·ª£': 'o',
  '√π': 'u', '√∫': 'u', '·ªß': 'u', '≈©': 'u', '·ª•': 'u',
  '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª≠': 'u', '·ªØ': 'u', '·ª±': 'u',
  '·ª≥': 'y', '√Ω': 'y', '·ª∑': 'y', '·ªπ': 'y', '·ªµ': 'y',
  '√Ä': 'a', '√Å': 'a', '·∫¢': 'a', '√É': 'a', '·∫†': 'a',
  'ƒÇ': 'a', '·∫∞': 'a', '·∫Æ': 'a', '·∫≤': 'a', '·∫¥': 'a', '·∫∂': 'a',
  '√Ç': 'a', '·∫¶': 'a', '·∫§': 'a', '·∫®': 'a', '·∫™': 'a', '·∫¨': 'a',
  'ƒê': 'd',
  '√à': 'e', '√â': 'e', '·∫∫': 'e', '·∫º': 'e', '·∫∏': 'e',
  '√ä': 'e', '·ªÄ': 'e', '·∫æ': 'e', '·ªÇ': 'e', '·ªÑ': 'e', '·ªÜ': 'e',
  '√å': 'i', '√ç': 'i', '·ªà': 'i', 'ƒ®': 'i', '·ªä': 'i',
  '√í': 'o', '√ì': 'o', '·ªé': 'o', '√ï': 'o', '·ªå': 'o',
  '√î': 'o', '·ªí': 'o', '·ªê': 'o', '·ªî': 'o', '·ªñ': 'o', '·ªò': 'o',
  '∆†': 'o', '·ªú': 'o', '·ªö': 'o', '·ªû': 'o', '·ª†': 'o', '·ª¢': 'o',
  '√ô': 'u', '√ö': 'u', '·ª¶': 'u', '≈®': 'u', '·ª§': 'u',
  '∆Ø': 'u', '·ª™': 'u', '·ª®': 'u', '·ª¨': 'u', '·ªÆ': 'u', '·ª∞': 'u',
  '·ª≤': 'y', '√ù': 'y', '·ª∂': 'y', '·ª∏': 'y', '·ª¥': 'y',
};

function transliterateToSlug(text: string): string {
  if (!text) return '';
  
  let slug = text
    .split('')
    .map(char => VIETNAMESE_CHAR_MAP[char] || char)
    .join('');
  
  slug = slug.toLowerCase();
  slug = slug
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim();
  slug = slug.replace(/^-+|-+$/g, '');
  
  return slug;
}

interface PageSettingsFormProps {
  page: Page;
  onUpdate: (page: Page) => void;
}

const getStatusDescription = (status: PageStatus) => {
  switch (status) {
    case PageStatus.DRAFT:
      return {
        title: 'Draft (B·∫£n Nh√°p)',
        description: 'Trang n√†y ƒëang ƒë∆∞·ª£c so·∫°n th·∫£o. Kh√¥ng hi·ªÉn th·ªã c√¥ng khai cho kh√°ch truy c·∫≠p.',
        icon: <AlertCircle className="w-5 h-5" />,
        color: 'text-yellow-600',
      };
    case PageStatus.PUBLISHED:
      return {
        title: 'Published (Xu·∫•t B·∫£n)',
        description: 'Trang n√†y ƒëang hi·ªÉn th·ªã c√¥ng khai. T·∫•t c·∫£ kh√°ch truy c·∫≠p c√≥ th·ªÉ xem.',
        icon: <CheckCircle className="w-5 h-5" />,
        color: 'text-green-600',
      };
    case PageStatus.ARCHIVED:
      return {
        title: 'Archived (L∆∞u Tr·ªØ)',
        description: 'Trang n√†y ƒë∆∞·ª£c l∆∞u tr·ªØ. Kh√¥ng hi·ªÉn th·ªã c√¥ng khai nh∆∞ng v·∫´n c√≥ th·ªÉ kh√¥i ph·ª•c.',
        icon: <Lock className="w-5 h-5" />,
        color: 'text-gray-600',
      };
  }
};

export default function PageSettingsForm({ page, onUpdate }: PageSettingsFormProps) {
  const [formData, setFormData] = useState({
    title: page.title || '',
    slug: page.slug || '',
    content: (page.content && typeof page.content === 'string') ? page.content : '',
    status: page.status,
    isHomepage: page.isHomepage ?? false,
    isDynamic: page.isDynamic ?? false,
    dynamicConfig: page.dynamicConfig,
    seoTitle: page.seoTitle || '',
    seoDescription: page.seoDescription || '',
    seoKeywords: (page.seoKeywords || []).join(', '),
  });

  const [isSlugAutoGenerated, setIsSlugAutoGenerated] = useState(
    page.slug === '' || page.slug?.startsWith('untitled')
  );
  const [showStatusChangeDialog, setShowStatusChangeDialog] = useState(false);
  const [pendingStatus, setPendingStatus] = useState<PageStatus | null>(null);

  // üÜï Use layout hook
  const { settings: layoutSettings, updateSetting: updateLayoutSetting } = usePageLayout({
    initialSettings: page.layoutSettings,
    onChange: (newSettings) => {
      const updatedPage = {
        ...page,
        ...formData,
        layoutSettings: newSettings,
        seoKeywords: formData.seoKeywords.split(',').map(k => k.trim()).filter(Boolean),
      };
      onUpdate(updatedPage);
    },
  });

  const currentStatusInfo = getStatusDescription(formData.status);

  const handleInputChange = (field: keyof typeof formData, value: any) => {
    if (field === 'status' && value !== formData.status) {
      setPendingStatus(value as PageStatus);
      setShowStatusChangeDialog(true);
      return;
    }

    const newFormData = { ...formData, [field]: value };
    
    if (field === 'title' && isSlugAutoGenerated) {
      const generatedSlug = transliterateToSlug(value);
      newFormData.slug = generatedSlug;
    }
    
    if (field === 'slug') {
      setIsSlugAutoGenerated(false);
    }
    
    setFormData(newFormData);
    
    const updatedPage = {
      ...page,
      ...newFormData,
      layoutSettings,
      content: field === 'content' && !value ? undefined : (field === 'content' ? value : page.content),
      seoKeywords: field === 'seoKeywords' 
        ? value.split(',').map((k: string) => k.trim()).filter(Boolean) 
        : page.seoKeywords,
    };
    onUpdate(updatedPage);
  };

  const handleConfirmStatusChange = () => {
    if (pendingStatus) {
      setFormData({ ...formData, status: pendingStatus });
      const updatedPage = {
        ...page,
        ...formData,
        status: pendingStatus,
        layoutSettings,
        seoKeywords: formData.seoKeywords.split(',').map((k: string) => k.trim()).filter(Boolean),
      };
      onUpdate(updatedPage);
    }
    setShowStatusChangeDialog(false);
    setPendingStatus(null);
  };

  const pendingStatusInfo = pendingStatus ? getStatusDescription(pendingStatus) : null;

  return (
    <>
      <Tabs defaultValue="general" className="w-full">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="general">T·ªïng Qu√°t</TabsTrigger>
          <TabsTrigger value="layout">B·ªë C·ª•c</TabsTrigger>
          <TabsTrigger value="seo">SEO</TabsTrigger>
        </TabsList>

        {/* General Tab */}
        <TabsContent value="general" className="space-y-4 mt-4">
          <div className="space-y-2">
            <Label htmlFor="title">Ti√™u ƒê·ªÅ Trang</Label>
            <Input
              id="title"
              value={formData.title}
              onChange={(e) => handleInputChange('title', e.target.value)}
              placeholder="Nh·∫≠p ti√™u ƒë·ªÅ trang..."
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="slug">Slug (URL)</Label>
            <Input
              id="slug"
              value={formData.slug}
              onChange={(e) => handleInputChange('slug', e.target.value)}
              placeholder="vi-du-slug-url"
            />
            <p className="text-xs text-muted-foreground">
              {isSlugAutoGenerated ? 'ü§ñ T·ª± ƒë·ªông t·∫°o t·ª´ ti√™u ƒë·ªÅ' : '‚úèÔ∏è ƒê∆∞·ª£c ch·ªânh s·ª≠a th·ªß c√¥ng'}
            </p>
          </div>

          <div className="space-y-2">
            <Label htmlFor="content">M√¥ T·∫£ Ng·∫Øn</Label>
            <Textarea
              id="content"
              value={formData.content}
              onChange={(e) => handleInputChange('content', e.target.value)}
              placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ trang (t√πy ch·ªçn)..."
              rows={3}
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="status">Tr·∫°ng Th√°i</Label>
            <Select value={formData.status} onValueChange={(value) => handleInputChange('status', value)}>
              <SelectTrigger id="status">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value={PageStatus.DRAFT}>B·∫£n Nh√°p</SelectItem>
                <SelectItem value={PageStatus.PUBLISHED}>Xu·∫•t B·∫£n</SelectItem>
                <SelectItem value={PageStatus.ARCHIVED}>L∆∞u Tr·ªØ</SelectItem>
              </SelectContent>
            </Select>
            <div className={`flex items-center gap-2 text-sm ${currentStatusInfo.color}`}>
              {currentStatusInfo.icon}
              <span>{currentStatusInfo.description}</span>
            </div>
          </div>

          <div className="border-t pt-4">
            <div className="flex items-center justify-between">
              <div className="space-y-0.5">
                <Label htmlFor="isHomepage">Trang Ch·ªß</Label>
                <p className="text-xs text-muted-foreground">
                  ƒê·∫∑t trang n√†y l√†m trang ch·ªß c·ªßa website
                </p>
              </div>
              <Switch
                id="isHomepage"
                checked={formData.isHomepage || false}
                onCheckedChange={(checked) => handleInputChange('isHomepage', checked)}
              />
            </div>
          </div>

          <div className="border-t pt-4">
            <div className="flex items-center justify-between">
              <div className="space-y-0.5">
                <Label htmlFor="isDynamic">Dynamic Page Template</Label>
                <p className="text-xs text-muted-foreground">
                  S·ª≠ d·ª•ng trang n√†y l√†m template cho nhi·ªÅu items v·ªõi slug kh√°c nhau
                </p>
              </div>
              <Switch
                id="isDynamic"
                checked={formData.isDynamic || false}
                onCheckedChange={(checked) => handleInputChange('isDynamic', checked)}
              />
            </div>
            {formData.isDynamic && (
              <div className="mt-4">
                <DynamicPageConfig
                  config={formData.dynamicConfig}
                  blocks={page.blocks}
                  onChange={(config) => handleInputChange('dynamicConfig', config)}
                />
              </div>
            )}
          </div>
        </TabsContent>

        {/* Layout Tab - üÜï Refactored */}
        <TabsContent value="layout" className="mt-4">
          <PageLayoutSettings
            settings={layoutSettings}
            onChange={(newSettings) => {
              const updatedPage = {
                ...page,
                ...formData,
                layoutSettings: newSettings,
                seoKeywords: formData.seoKeywords.split(',').map(k => k.trim()).filter(Boolean),
              };
              onUpdate(updatedPage);
            }}
          />
        </TabsContent>

        {/* SEO Tab */}
        <TabsContent value="seo" className="space-y-4 mt-4">
          <div className="space-y-2">
            <Label htmlFor="seoTitle">Ti√™u ƒê·ªÅ SEO</Label>
            <Input
              id="seoTitle"
              value={formData.seoTitle}
              onChange={(e) => handleInputChange('seoTitle', e.target.value)}
              placeholder="Ti√™u ƒë·ªÅ t·ªëi ∆∞u cho SEO (50-60 k√Ω t·ª±)..."
            />
            <p className="text-xs text-muted-foreground">
              {formData.seoTitle.length}/60 k√Ω t·ª±
            </p>
          </div>

          <div className="space-y-2">
            <Label htmlFor="seoDescription">M√¥ T·∫£ SEO</Label>
            <Textarea
              id="seoDescription"
              value={formData.seoDescription}
              onChange={(e) => handleInputChange('seoDescription', e.target.value)}
              placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ n·ªôi dung trang (150-160 k√Ω t·ª±)..."
              rows={3}
            />
            <p className="text-xs text-muted-foreground">
              {formData.seoDescription.length}/160 k√Ω t·ª±
            </p>
          </div>

          <div className="space-y-2">
            <Label htmlFor="seoKeywords">T·ª´ Kh√≥a SEO</Label>
            <Input
              id="seoKeywords"
              value={formData.seoKeywords}
              onChange={(e) => handleInputChange('seoKeywords', e.target.value)}
              placeholder="t·ª´ kh√≥a 1, t·ª´ kh√≥a 2, t·ª´ kh√≥a 3..."
            />
            <p className="text-xs text-muted-foreground">
              Ph√¢n c√°ch c√°c t·ª´ kh√≥a b·∫±ng d·∫•u ph·∫©y
            </p>
          </div>
        </TabsContent>
      </Tabs>

      {/* Status Change Confirmation Dialog */}
      <Dialog open={showStatusChangeDialog} onOpenChange={setShowStatusChangeDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>X√°c Nh·∫≠n Thay ƒê·ªïi Tr·∫°ng Th√°i</DialogTitle>
            <DialogDescription>
              B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i trang?
            </DialogDescription>
          </DialogHeader>
          
          {pendingStatusInfo && (
            <div className="py-4 space-y-4">
              <div className="flex items-start gap-3">
                <div className={pendingStatusInfo.color}>
                  {pendingStatusInfo.icon}
                </div>
                <div className="space-y-1">
                  <h4 className="font-semibold">{pendingStatusInfo.title}</h4>
                  <p className="text-sm text-muted-foreground">
                    {pendingStatusInfo.description}
                  </p>
                </div>
              </div>
            </div>
          )}

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowStatusChangeDialog(false)}>
              H·ªßy
            </Button>
            <Button onClick={handleConfirmStatusChange}>
              X√°c Nh·∫≠n
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}

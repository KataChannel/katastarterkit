name: Dependency Updates

on:
  schedule:
    # Check for updates every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-backend-dependencies:
    name: Update Backend Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Check for outdated dependencies
      id: check_backend
      working-directory: ./backend
      run: |
        echo "Checking backend dependencies..."
        
        # Get outdated packages
        OUTDATED=$(bun outdated --json 2>/dev/null || echo '{}')
        echo "outdated_packages<<EOF" >> $GITHUB_OUTPUT
        echo "$OUTDATED" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Count outdated packages
        OUTDATED_COUNT=$(echo "$OUTDATED" | jq -r '. | length' 2>/dev/null || echo "0")
        echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
        
        echo "Found $OUTDATED_COUNT outdated backend packages"
    
    - name: Update backend dependencies
      if: steps.check_backend.outputs.outdated_count != '0'
      working-directory: ./backend
      run: |
        echo "Updating backend dependencies..."
        
        # Create backup of current package.json
        cp package.json package.json.backup
        
        # Update dependencies
        bun update
        
        # Check if package.json changed
        if ! diff -q package.json package.json.backup >/dev/null; then
          echo "backend_updated=true" >> $GITHUB_OUTPUT
          echo "Backend dependencies updated"
        else
          echo "backend_updated=false" >> $GITHUB_OUTPUT
          echo "No backend updates available"
        fi
    
    - name: Test backend after updates
      if: steps.check_backend.outputs.outdated_count != '0'
      working-directory: ./backend
      run: |
        echo "Testing backend after dependency updates..."
        
        # Install dependencies
        bun install --frozen-lockfile
        
        # Run type check
        bun run type-check
        
        # Run linting
        bun run lint
        
        # Run tests
        bun run test

  update-frontend-dependencies:
    name: Update Frontend Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Check for outdated dependencies
      id: check_frontend
      working-directory: ./frontend
      run: |
        echo "Checking frontend dependencies..."
        
        # Get outdated packages
        OUTDATED=$(bun outdated --json 2>/dev/null || echo '{}')
        echo "outdated_packages<<EOF" >> $GITHUB_OUTPUT
        echo "$OUTDATED" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Count outdated packages
        OUTDATED_COUNT=$(echo "$OUTDATED" | jq -r '. | length' 2>/dev/null || echo "0")
        echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
        
        echo "Found $OUTDATED_COUNT outdated frontend packages"
    
    - name: Update frontend dependencies
      if: steps.check_frontend.outputs.outdated_count != '0'
      working-directory: ./frontend
      run: |
        echo "Updating frontend dependencies..."
        
        # Create backup of current package.json
        cp package.json package.json.backup
        
        # Update dependencies
        bun update
        
        # Check if package.json changed
        if ! diff -q package.json package.json.backup >/dev/null; then
          echo "frontend_updated=true" >> $GITHUB_OUTPUT
          echo "Frontend dependencies updated"
        else
          echo "frontend_updated=false" >> $GITHUB_OUTPUT
          echo "No frontend updates available"
        fi
    
    - name: Test frontend after updates
      if: steps.check_frontend.outputs.outdated_count != '0'
      working-directory: ./frontend
      run: |
        echo "Testing frontend after dependency updates..."
        
        # Install dependencies
        bun install --frozen-lockfile
        
        # Run type check
        bun run type-check
        
        # Run linting
        bun run lint
        
        # Try to build
        bun run build
        
        # Run tests
        bun run test

  update-docker-images:
    name: Update Docker Base Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Check for Docker image updates
      id: check_docker
      run: |
        echo "Checking for Docker base image updates..."
        
        # Extract current base images
        BACKEND_IMAGE=$(grep "FROM" backend/Dockerfile | head -1 | awk '{print $2}')
        FRONTEND_IMAGE=$(grep "FROM" frontend/Dockerfile | head -1 | awk '{print $2}')
        
        echo "Backend base image: $BACKEND_IMAGE"
        echo "Frontend base image: $FRONTEND_IMAGE"
        
        # Check for newer versions (this is a simplified check)
        # In a real scenario, you might want to use specific tools or APIs
        
        echo "backend_image=$BACKEND_IMAGE" >> $GITHUB_OUTPUT
        echo "frontend_image=$FRONTEND_IMAGE" >> $GITHUB_OUTPUT
        
        # Set update needed flag (for demo purposes)
        echo "docker_update_needed=false" >> $GITHUB_OUTPUT

  create-dependency-update-pr:
    name: Create Dependency Update PR
    runs-on: ubuntu-latest
    needs: [update-backend-dependencies, update-frontend-dependencies, update-docker-images]
    if: always() && (needs.update-backend-dependencies.result == 'success' || needs.update-frontend-dependencies.result == 'success')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Re-run dependency updates
      run: |
        echo "Re-running dependency updates for PR creation..."
        
        # Update backend
        cd backend
        if [ -f package.json ]; then
          bun update
          echo "Backend dependencies updated"
        fi
        cd ..
        
        # Update frontend
        cd frontend
        if [ -f package.json ]; then
          bun update
          echo "Frontend dependencies updated"
        fi
        cd ..
    
    - name: Check for changes
      id: check_changes
      run: |
        # Check if there are any changes
        if git diff --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Show what changed
          echo "Changed files:"
          git diff --name-only
        fi
    
    - name: Generate changelog
      if: steps.check_changes.outputs.has_changes == 'true'
      id: changelog
      run: |
        echo "Generating dependency update changelog..."
        
        CHANGELOG="## Dependency Updates\n\n"
        CHANGELOG="${CHANGELOG}This PR contains automatic dependency updates.\n\n"
        
        # Backend changes
        if [ -f backend/package.json ] && git diff --quiet backend/package.json; then
          CHANGELOG="${CHANGELOG}### Backend Dependencies\n"
          CHANGELOG="${CHANGELOG}- Updated dependencies to latest compatible versions\n\n"
        fi
        
        # Frontend changes
        if [ -f frontend/package.json ] && git diff --quiet frontend/package.json; then
          CHANGELOG="${CHANGELOG}### Frontend Dependencies\n"
          CHANGELOG="${CHANGELOG}- Updated dependencies to latest compatible versions\n\n"
        fi
        
        CHANGELOG="${CHANGELOG}### Changes\n"
        CHANGELOG="${CHANGELOG}\`\`\`\n"
        CHANGELOG="${CHANGELOG}$(git diff --stat)\n"
        CHANGELOG="${CHANGELOG}\`\`\`\n\n"
        
        CHANGELOG="${CHANGELOG}### Testing\n"
        CHANGELOG="${CHANGELOG}- âœ… All tests pass\n"
        CHANGELOG="${CHANGELOG}- âœ… Type checking passes\n"
        CHANGELOG="${CHANGELOG}- âœ… Linting passes\n"
        CHANGELOG="${CHANGELOG}- âœ… Build completes successfully\n\n"
        
        CHANGELOG="${CHANGELOG}---\n"
        CHANGELOG="${CHANGELOG}*This PR was automatically created by the dependency update workflow.*"
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Pull Request
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: update dependencies
          
          - Update backend dependencies to latest compatible versions
          - Update frontend dependencies to latest compatible versions
          - All tests pass after updates
        title: "ðŸ”„ Automatic Dependency Updates - $(date +'%Y-%m-%d')"
        body: ${{ steps.changelog.outputs.changelog }}
        branch: dependency-updates/$(date +'%Y-%m-%d')
        delete-branch: true
        draft: false
        reviewers: |
          # Add your team members here
        assignees: |
          # Add default assignees here
        labels: |
          dependencies
          automated
          maintenance

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Audit backend dependencies
      working-directory: ./backend
      run: |
        echo "Running security audit for backend..."
        
        # Install dependencies
        bun install --frozen-lockfile
        
        # Run audit (bun doesn't have built-in audit yet, so use npm)
        if command -v npm >/dev/null 2>&1; then
          npm audit --audit-level=moderate || echo "Security vulnerabilities found"
        else
          echo "npm not available for audit"
        fi
    
    - name: Audit frontend dependencies
      working-directory: ./frontend
      run: |
        echo "Running security audit for frontend..."
        
        # Install dependencies
        bun install --frozen-lockfile
        
        # Run audit
        if command -v npm >/dev/null 2>&1; then
          npm audit --audit-level=moderate || echo "Security vulnerabilities found"
        else
          echo "npm not available for audit"
        fi
    
    - name: Check for known vulnerabilities
      run: |
        echo "Checking for known vulnerabilities..."
        
        # This could be extended to use specific security scanning tools
        # like Snyk, WhiteSource, or GitHub's Dependabot
        
        echo "Security audit completed"

# Product Normalization GraphQL Queries
# 
# Example queries for testing fuzzy matching functionality
# Use in GraphQL Playground or your GraphQL client

# ============================================
# Query 1: Find Similar Products
# ============================================
# Find products similar to "main asus i7"
query FindSimilarProducts {
  findSimilarProducts(
    searchText: "main asus i7"
    threshold: 0.6
  ) {
    id
    ten
    ten2
    ma
    similarityScore
  }
}

# Expected Response:
# {
#   "data": {
#     "findSimilarProducts": [
#       {
#         "id": "abc-123",
#         "ten": "main asus i7",
#         "ten2": "Main Asus I7",
#         "ma": "MAI7",
#         "similarityScore": 1.0
#       },
#       {
#         "id": "abc-124",
#         "ten": "asus i7 main",
#         "ten2": "Main Asus I7",
#         "ma": "AI7M",
#         "similarityScore": 0.85
#       }
#     ]
#   }
# }


# ============================================
# Query 2: Find Canonical Name
# ============================================
# Find the canonical (normalized) name for a product
query FindCanonicalName {
  findCanonicalName(
    productName: "bo mạch asus i7300"
    threshold: 0.6
  )
}

# Expected Response:
# {
#   "data": {
#     "findCanonicalName": "Main Asus I7300"
#   }
# }


# ============================================
# Query 3: Normalize Product Name
# ============================================
# Normalize a product name (find or create)
query NormalizeProductName {
  normalizeProductName(
    productName: "  main  ASUS   i7-300  "
    threshold: 0.6
  )
}

# Expected Response:
# {
#   "data": {
#     "normalizeProductName": "Main Asus I7300"
#   }
# }


# ============================================
# Query 4: Get Product Groups
# ============================================
# Get all product groups (by ten2) with at least 2 products
query GetProductGroups {
  getProductGroups(minGroupSize: 2) {
    ten2
    count
    products {
      id
      ten
      ma
      dgia
    }
  }
}

# Expected Response:
# {
#   "data": {
#     "getProductGroups": [
#       {
#         "ten2": "Main Asus I7",
#         "count": 5,
#         "products": [
#           {
#             "id": "1",
#             "ten": "main asus i7",
#             "ma": "MAI7",
#             "dgia": "5000000"
#           },
#           {
#             "id": "2",
#             "ten": "asus i7 main",
#             "ma": "AI7M",
#             "dgia": "5100000"
#           }
#         ]
#       }
#     ]
#   }
# }


# ============================================
# Query 5: Find Duplicates
# ============================================
# Find all duplicate products (same ten2)
query FindDuplicates {
  findDuplicates {
    ten2
    count
    productIds
  }
}

# Expected Response:
# {
#   "data": {
#     "findDuplicates": [
#       {
#         "ten2": "Clm Tương Ớt Pet 21kg",
#         "count": 5,
#         "productIds": ["id1", "id2", "id3", "id4", "id5"]
#       }
#     ]
#   }
# }


# ============================================
# Query 6: Test Similarity
# ============================================
# Test similarity between two strings
query TestSimilarity {
  testSimilarity(
    text1: "main asus i7"
    text2: "asus i7 main"
  )
}

# Expected Response:
# {
#   "data": {
#     "testSimilarity": 0.85
#   }
# }


# ============================================
# Mutation 1: Normalize All Products
# ============================================
# Batch normalize all products without ten2
mutation NormalizeAllProducts {
  normalizeProducts(threshold: 0.6) {
    updated
    skipped
    errors
  }
}

# Expected Response:
# {
#   "data": {
#     "normalizeProducts": {
#       "updated": 15890,
#       "skipped": 478,
#       "errors": 0
#     }
#   }
# }


# ============================================
# Mutation 2: Normalize Specific Products
# ============================================
# Normalize only specific product IDs
mutation NormalizeSpecificProducts {
  normalizeProducts(
    productIds: ["abc-123", "abc-124", "abc-125"]
    threshold: 0.7
  ) {
    updated
    skipped
    errors
  }
}

# Expected Response:
# {
#   "data": {
#     "normalizeProducts": {
#       "updated": 3,
#       "skipped": 0,
#       "errors": 0
#     }
#   }
# }


# ============================================
# Mutation 3: Merge Duplicates
# ============================================
# Merge all products with ten2 = "Main Asus I7"
# Keeps the oldest product, deletes the rest
mutation MergeDuplicates {
  mergeDuplicates(ten2: "Main Asus I7")
}

# Expected Response:
# {
#   "data": {
#     "mergeDuplicates": 4  # 4 duplicates deleted
#   }
# }


# ============================================
# Mutation 4: Merge Duplicates (Keep Specific)
# ============================================
# Merge duplicates but keep a specific product
mutation MergeDuplicatesKeepSpecific {
  mergeDuplicates(
    ten2: "Main Asus I7"
    keepId: "abc-123"  # Keep this one
  )
}

# Expected Response:
# {
#   "data": {
#     "mergeDuplicates": 4
#   }
# }


# ============================================
# Complex Query: Find Similar with Details
# ============================================
# Find similar products and show their groups
query FindSimilarWithGroups {
  similar: findSimilarProducts(
    searchText: "laptop dell"
    threshold: 0.5
  ) {
    id
    ten
    ten2
    similarityScore
  }
  
  groups: getProductGroups(minGroupSize: 1) {
    ten2
    count
  }
  
  duplicates: findDuplicates {
    ten2
    count
  }
}


# ============================================
# Testing Workflow
# ============================================

# Step 1: Test similarity between variations
query Step1_TestSimilarity {
  similarity1: testSimilarity(
    text1: "main asus i7"
    text2: "asus i7 main"
  )
  
  similarity2: testSimilarity(
    text1: "main asus i7"
    text2: "bo mạch asus i7300"
  )
}

# Step 2: Find what canonical name will be used
query Step2_FindCanonical {
  canonical: findCanonicalName(
    productName: "main asus i7"
    threshold: 0.6
  )
}

# Step 3: Normalize a sample
mutation Step3_NormalizeSample {
  normalizeProducts(
    productIds: ["sample-id-1", "sample-id-2"]
    threshold: 0.6
  ) {
    updated
    skipped
    errors
  }
}

# Step 4: Check results
query Step4_CheckResults {
  groups: getProductGroups(minGroupSize: 1) {
    ten2
    count
    products {
      ten
      ten2
    }
  }
}

# Step 5: Clean up duplicates
mutation Step5_CleanupDuplicates {
  mergeDuplicates(ten2: "Main Asus I7")
}


# ============================================
# Production Workflow
# ============================================

# 1. Preview: Find what will be grouped
query PreviewGrouping {
  findSimilarProducts(searchText: "your-product-name", threshold: 0.6) {
    ten
    ten2
    similarityScore
  }
}

# 2. Normalize: Apply normalization
mutation ApplyNormalization {
  normalizeProducts(threshold: 0.6) {
    updated
    skipped
    errors
  }
}

# 3. Review: Check groups
query ReviewGroups {
  getProductGroups(minGroupSize: 2) {
    ten2
    count
  }
}

# 4. Cleanup: Merge duplicates
mutation CleanupDuplicates {
  # For each duplicate group:
  mergeDuplicates(ten2: "Product Group Name")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  firstName String?
  lastName  String?
  avatar    String?
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing Relations
  posts    Post[]
  comments Comment[]
  likes    Like[]

  // Todo Management Relations
  tasks           Task[]
  taskMedia       TaskMedia[]
  tasksSharedBy   TaskShare[]    @relation("TaskSharedBy")
  tasksSharedWith TaskShare[]    @relation("TaskSharedWith")
  taskComments    TaskComment[]
  notifications   Notification[]

  @@map("users")
}

model Post {
  id            String     @id @default(uuid())
  title         String
  content       String
  excerpt       String?
  slug          String     @unique
  featuredImage String?
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  comments Comment[]
  likes    Like[]
  tags     PostTag[]

  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  @@map("comments")
}

model Like {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("likes")
}

model Tag {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts PostTag[]

  @@map("tags")
}

model PostTag {
  id     String @id @default(uuid())
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@map("post_tags")
}

// File Upload Model
model FileUpload {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimetype     String
  size         Int
  url          String
  bucket       String
  path         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("file_uploads")
}

// Todo Management Enums
enum TaskCategory {
  WORK // Công việc
  PERSONAL // Cá nhân
  STUDY // Học tập
}

enum TaskPriority {
  HIGH // Cao
  MEDIUM // Trung bình
  LOW // Thấp
}

enum TaskStatus {
  PENDING // Đang chờ
  IN_PROGRESS // Đang thực hiện
  COMPLETED // Hoàn thành
  CANCELLED // Đã hủy
}

enum SharePermission {
  VIEW // Chỉ xem
  EDIT // Chỉnh sửa
  ADMIN // Quản trị viên
}

enum MediaType {
  IMAGE // Hình ảnh
  VIDEO // Video
  DOCUMENT // Tài liệu
}

// Todo Management Models
model Task {
  id          String       @id @default(uuid())
  title       String
  description String?
  category    TaskCategory @default(PERSONAL)
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Media attachments
  attachments TaskMedia[]

  // Sharing and collaboration
  shares TaskShare[]

  // Comments and collaboration
  comments TaskComment[]

  // Subtasks
  parentId String?
  parent   Task?   @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks Task[]  @relation("TaskSubtasks")

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([dueDate])
  @@map("tasks")
}

model TaskMedia {
  id        String    @id @default(uuid())
  type      MediaType
  url       String
  filename  String
  size      Int
  mimeType  String
  caption   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  uploadedBy String
  uploader   User   @relation(fields: [uploadedBy], references: [id])

  @@index([taskId])
  @@index([type])
  @@map("task_media")
}

model TaskShare {
  id         String          @id @default(uuid())
  permission SharePermission @default(VIEW)
  shareToken String          @unique
  expiresAt  DateTime?
  isActive   Boolean         @default(true)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  sharedBy     String
  sharedByUser User   @relation("TaskSharedBy", fields: [sharedBy], references: [id])

  sharedWith     String?
  sharedWithUser User?   @relation("TaskSharedWith", fields: [sharedWith], references: [id])

  @@index([shareToken])
  @@index([taskId])
  @@map("task_shares")
}

model TaskComment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Reply to comment
  parentId String?
  parent   TaskComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  TaskComment[] @relation("CommentReplies")

  @@index([taskId])
  @@index([userId])
  @@map("task_comments")
}

// Notification system
model Notification {
  id        String   @id @default(uuid())
  type      String // task_created, task_updated, task_shared, etc.
  title     String
  message   String
  data      Json? // Additional data (task id, etc.)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

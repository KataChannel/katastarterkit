// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
  PHONE
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  PHONE_VERIFICATION
  TWO_FACTOR
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TaskCategory {
  PERSONAL
  WORK
  SHOPPING
  HEALTH
  OTHER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum SharePermission {
  VIEW
  EDIT
  ADMIN
}

model User {
  id          String   @id @default(uuid())
  email       String?  @unique
  username    String   @unique
  password    String?
  phone       String?  @unique
  firstName   String?
  lastName    String?
  avatar      String?
  role        UserRole @default(USER)
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  
  // Security settings
  isTwoFactorEnabled Boolean @default(false)
  failedLoginAttempts Int @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  authMethods        AuthMethod[]
  verificationTokens VerificationToken[]
  sessions           UserSession[]
  auditLogs          AuditLog[]
  
  // Content relations
  posts         Post[]        @relation("PostAuthor")
  comments      Comment[]     @relation("CommentAuthor")
  likes         Like[]        @relation("UserLikes")
  notifications Notification[] @relation("UserNotifications")
  tasks         Task[]        @relation("UserTasks")
  taskComments  TaskComment[] @relation("TaskCommentAuthor")
  taskMedia     TaskMedia[]   @relation("TaskMediaUploader")
  
  // Task sharing relations
  tasksSharedBy   TaskShare[] @relation("TaskSharedBy")
  tasksSharedWith TaskShare[] @relation("TaskSharedWith")

  // AI Training relations
  chatbotModels     ChatbotModel[]
  trainingData      TrainingData[]
  chatConversations ChatConversation[]

  @@map("users")
}

model AuthMethod {
  id         String       @id @default(uuid())
  userId     String
  provider   AuthProvider
  providerId String?      // External provider ID (Google ID, Facebook ID, etc.)
  isVerified Boolean      @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("auth_methods")
}

model VerificationToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType
  expiresAt DateTime
  isUsed    Boolean   @default(false)
  
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_tokens")
}

model UserSession {
  id          String    @id @default(uuid())
  userId      String
  sessionId   String    @unique
  refreshToken String   @unique
  ipAddress   String?
  userAgent   String?
  isActive    Boolean   @default(true)
  expiresAt   DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  details   Json?
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model Post {
  id            String     @id @default(uuid())
  title         String
  content       String
  excerpt       String?
  slug          String     @unique
  featuredImage String?
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  authorId String
  author   User   @relation("PostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  // Relations
  comments Comment[]
  likes    Like[]
  tags     PostTag[] @relation("PostTags")

  @@map("posts")
}

model Comment {
  id      String @id @default(uuid())
  content String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  
  parentId String?
  parent   Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  @@map("comments")
}

model Tag {
  id    String @id @default(uuid())
  name  String @unique
  slug  String @unique
  color String?
  
  createdAt DateTime @default(now())
  
  posts PostTag[] @relation("TagPosts")

  @@map("tags")
}

model Like {
  id     String @id @default(uuid())
  postId String
  userId String
  
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation("UserLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("likes")
}

model PostTag {
  postId String
  tagId  String
  
  post Post @relation("PostTags", fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation("TagPosts", fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
}

model Notification {
  id        String  @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean @default(false)
  data      Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Task {
  id          String       @id @default(uuid())
  title       String
  description String?
  category    TaskCategory @default(OTHER)
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId String
  user   User   @relation("UserTasks", fields: [userId], references: [id], onDelete: Cascade)
  
  // Hierarchical relations
  parentId  String?
  parent    Task?   @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks  Task[]  @relation("TaskSubtasks")
  
  // Relations
  comments TaskComment[]
  media    TaskMedia[]
  shares   TaskShare[]

  @@map("tasks")
}

model TaskComment {
  id      String @id @default(uuid())
  content String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation("TaskCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  
  parentId String?
  parent   TaskComment? @relation("TaskCommentReplies", fields: [parentId], references: [id])
  replies  TaskComment[] @relation("TaskCommentReplies")

  @@map("task_comments")
}

model TaskMedia {
  id        String    @id @default(uuid())
  type      MediaType
  url       String
  filename  String
  size      Int
  mimeType  String
  caption   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  uploadedBy String
  uploader   User   @relation("TaskMediaUploader", fields: [uploadedBy], references: [id])

  @@map("task_media")
}

model TaskShare {
  id         String          @id @default(uuid())
  permission SharePermission @default(VIEW)
  shareToken String          @unique
  expiresAt  DateTime?
  isActive   Boolean         @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  sharedBy     String
  sharedByUser User   @relation("TaskSharedBy", fields: [sharedBy], references: [id])

  sharedWith     String?
  sharedWithUser User?   @relation("TaskSharedWith", fields: [sharedWith], references: [id])

  @@index([shareToken])
  @@map("task_shares")
}

// AI Training and Chatbot Models
enum TrainingDataType {
  DOCUMENT
  TEXT
  FAQ
  CONVERSATION
  KNOWLEDGE_BASE
}

enum TrainingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ChatbotStatus {
  ACTIVE
  INACTIVE
  TRAINING
}

model ChatbotModel {
  id          String        @id @default(uuid())
  name        String
  description String?
  systemPrompt String       @default("You are a helpful AI assistant.")
  status      ChatbotStatus @default(INACTIVE)
  
  // Model configuration
  temperature    Float   @default(0.7)
  maxTokens     Int     @default(1000)
  topP          Float   @default(1.0)
  frequencyPenalty Float @default(0.0)
  presencePenalty  Float @default(0.0)
  
  // Training metrics
  totalTrainingTokens Int @default(0)
  lastTrainedAt      DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  trainingData TrainingData[]
  conversations ChatConversation[]
  
  @@map("chatbot_models")
}

model TrainingData {
  id          String           @id @default(uuid())
  title       String
  content     String           @db.Text
  type        TrainingDataType
  status      TrainingStatus   @default(PENDING)
  
  // File information if uploaded
  fileName    String?
  fileSize    Int?
  filePath    String?
  
  // Processing information
  processedAt DateTime?
  errorMessage String?
  tokenCount  Int?
  
  // Embeddings for vector search
  embeddings  Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chatbotId   String
  chatbot     ChatbotModel @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([chatbotId, status])
  @@map("training_data")
}

model ChatConversation {
  id        String   @id @default(uuid())
  title     String?
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chatbotId String
  chatbot   ChatbotModel @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  messages  ChatMessage[]
  
  @@index([userId, chatbotId])
  @@map("chat_conversations")
}

model ChatMessage {
  id        String   @id @default(uuid())
  content   String   @db.Text
  role      String   // 'user' or 'assistant'
  
  // Response metadata
  tokenCount     Int?
  responseTime   Int?     // milliseconds
  relevantData   Json?    // references to training data used
  
  createdAt DateTime @default(now())

  // Relations
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId, createdAt])
  @@map("chat_messages")
}

model Hoadon {
  id            String          @id @default(uuid())
  nbmst         String
  khmshdon      Int?
  khhdon        String?
  shdon         Int?
  cqt           String?
  cttkhac       Json?
  dvtte         String?
  hdon          String?
  hsgcma        String?
  hsgoc         String?
  hthdon        Int?
  htttoan       Int?
  idtbao        String?
  khdon         String?
  khhdgoc       String?
  khmshdgoc     String?
  lhdgoc        Int?
  mhdon         String?
  mtdiep        String?
  mtdtchieu     String?
  nbdchi        String?
  nbhdktngay    DateTime?
  nbhdktso      String?
  nbhdso        String?
  nblddnbo      String?
  nbptvchuyen   String?
  nbstkhoan     String?
  nbten         String?
  nbtnhang      String?
  nbtnvchuyen   String?
  ncma          DateTime?
  ncnhat        DateTime?
  ngcnhat       String?
  nky           DateTime?
  nmdchi        String?
  nmmst         String?
  nmstkhoan     String?
  nmten         String?
  nmtnhang      String?
  nmtnmua       String?
  ntao          DateTime?
  ntnhan        DateTime?
  pban          String?
  ptgui         Int?
  shdgoc        Int?
  tchat         Int?
  tdlap         DateTime?
  tgia          Int?
  tgtcthue      Int?
  tgtthue       Int?
  tgtttbchu     String?
  tgtttbso      Int?
  thdon         String?
  thlap         Int?
  thttlphi      Json?
  tlhdon        String?
  ttcktmai      Int?
  tthai         Int?
  tttbao        Int?
  ttxly         Int?
  tvandnkntt    String?
  mhso          String?
  ladhddt       Int?
  mkhang        String?
  nbsdthoai     String?
  nbdctdtu      String?
  nbfax         String?
  nbwebsite     String?
  nbcks         String?
  nmsdthoai     String?
  nmdctdtu      String?
  nmcmnd        String?
  nmcks         String?
  bhphap        Int?
  hddunlap      String?
  gchdgoc       String?
  tbhgtngay     DateTime?
  bhpldo        String?
  bhpcbo        String?
  bhpngay       DateTime?
  tdlhdgoc      String?
  tgtphi        Int?
  unhiem        String?
  mstdvnunlhdon String?
  tdvnunlhdon   String?
  nbmdvqhnsach  String?
  nbsqdinh      String?
  nbncqdinh     String?
  nbcqcqdinh    String?
  nbhtban       String?
  nmmdvqhnsach  String?
  nmddvchden    String?
  nmtgvchdtu    String?
  nmtgvchdden   String?
  nbtnban       String?
  dcdvnunlhdon  String?
  dksbke        String?
  dknlbke       String?
  thtttoan      String?
  msttcgp       String?
  gchu          String?
  kqcht         String?
  hdntgia       String?
  tgtkcthue     String?
  tgtkhac       Int?
  nmshchieu     String?
  nmnchchieu    String?
  nmnhhhchieu   String?
  nmqtich       String?
  ktkhthue      String?
  hdhhdvu       String?
  qrcode        String?
  ttmstten      String?
  ladhddtten    String?
  hdxkhau       String?
  hdxkptquan    String?
  hdgktkhthue   String?
  hdonLquans    Json?
  tthdclquan    Boolean?
  pdndungs      Json?
  hdtbssrses    Json?
  hdTrung       String?
  isHDTrung     Boolean?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  HoadonChitiet HoadonChitiet[]
}

model HoadonChitiet {
  id        String   @id @default(uuid())
  codeId    String?
  title     String?
  title2    String?
  idhdon    String
  idhoadon  String
  hoadon    Hoadon   @relation(fields: [idhoadon], references: [id], onDelete: Cascade)
  dgia      Int?
  dvtinh    String?
  ltsuat    String?
  sluong    Int?
  stbchu    String?
  stckhau   Int?
  stt       Int?
  tchat     Int?
  ten       String?
  thtcthue  Int?
  thtien    Int?
  tlckhau   Int?
  tsuat     Float?
  tthue     Int?
  sxep      Int?
  dvtte     String?
  tgia      Int?
  order     Int?     @default(1)
  isproduct Boolean? @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([idhdon])
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRoleType {
  ADMIN
  USER
  GUEST
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
  PHONE
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  PHONE_VERIFICATION
  TWO_FACTOR
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TaskCategory {
  PERSONAL
  WORK
  SHOPPING
  HEALTH
  OTHER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum SharePermission {
  VIEW
  EDIT
  ADMIN
}

model User {
  id          String   @id @default(uuid())
  email       String?  @unique
  username    String   @unique
  password    String?
  phone       String?  @unique
  firstName   String?
  lastName    String?
  avatar      String?
  roleType    UserRoleType @default(USER)
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  
  // Security settings
  isTwoFactorEnabled Boolean @default(false)
  failedLoginAttempts Int @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  authMethods        AuthMethod[]
  verificationTokens VerificationToken[]
  sessions           UserSession[]
  auditLogs          AuditLog[]
  
  // RBAC Relations
  userRoles          UserRoleAssignment[]
  userPermissions    UserPermission[]
  resourceAccesses   ResourceAccess[]
  
  // Content relations
  posts         Post[]        @relation("PostAuthor")
  comments      Comment[]     @relation("CommentAuthor")
  likes         Like[]        @relation("UserLikes")
  notifications Notification[] @relation("UserNotifications")
  tasks         Task[]        @relation("UserTasks")
  taskComments  TaskComment[] @relation("TaskCommentAuthor")
  taskMedia     TaskMedia[]   @relation("TaskMediaUploader")
  
  // Task sharing relations
  tasksSharedBy   TaskShare[] @relation("TaskSharedBy")
  tasksSharedWith TaskShare[] @relation("TaskSharedWith")

  // AI Training relations
  chatbotModels     ChatbotModel[]
  trainingData      TrainingData[]
  chatConversations ChatConversation[]

  // Security relations
  mfaSettings       UserMfaSettings?
  devices           UserDevice[]
  securityEvents    SecurityEvent[]

  // Performance indexes for GIAI ĐOẠN 1 optimization
  @@index([isActive])
  @@index([roleType])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@map("users")
}

model AuthMethod {
  id         String       @id @default(uuid())
  userId     String
  provider   AuthProvider
  providerId String?      // External provider ID (Google ID, Facebook ID, etc.)
  isVerified Boolean      @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("auth_methods")
}

model VerificationToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType
  expiresAt DateTime
  isUsed    Boolean   @default(false)
  
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_tokens")
}

model UserSession {
  id           String    @id @default(uuid())
  userId       String
  sessionId    String    @unique
  refreshToken String?   @unique
  deviceId     String?   // Link to user device
  ipAddress    String?
  userAgent    String?
  location     String?   // Geographic location
  isActive     Boolean   @default(true)
  expiresAt    DateTime
  lastActivity DateTime  @default(now())
  
  // MFA
  mfaVerified  Boolean   @default(false)
  mfaMethod    String?   // Method used for MFA verification
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device UserDevice? @relation(fields: [deviceId], references: [deviceId], onDelete: SetNull)

  @@index([deviceId])
  @@index([lastActivity])
  @@map("user_sessions")
}

model AuditLog {
  id            String   @id @default(uuid())
  userId        String?
  sessionId     String?
  
  // Event Details
  action        String   // Action performed (login, logout, create, update, delete, etc.)
  resourceType  String   // Type of resource affected (user, task, project, etc.)
  resourceId    String?  // ID of the affected resource
  
  // Request Details
  ipAddress     String?
  userAgent     String?
  method        String?  // HTTP method
  endpoint      String?  // API endpoint
  
  // Event Data
  oldValues     Json?    // Previous values (for updates)
  newValues     Json?    // New values (for creates/updates)
  details       Json?    // Additional event details
  
  // Outcome
  success       Boolean  @default(true)
  errorMessage  String?  // Error message if action failed
  
  // Performance Metrics
  responseTime  Int?     // Response time in milliseconds
  requestSize   Int?     // Request payload size in bytes
  responseSize  Int?     // Response payload size in bytes
  dbQueryTime   Int?     // Database query time in milliseconds
  dbQueryCount  Int?     // Number of database queries executed
  memoryUsage   Float?   // Memory usage in MB
  cpuUsage      Float?   // CPU usage percentage
  statusCode    Int?     // HTTP status code
  
  // Performance Context
  performanceData Json?  // Additional performance metrics and traces
  
  // Metadata
  correlationId String?  // For tracking related events
  sessionInfo   Json?    // Session information at time of event
  
  // Timestamps
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([resourceType])
  @@index([timestamp])
  @@index([correlationId])
  @@index([endpoint])
  @@index([responseTime])
  @@index([statusCode])
  @@map("audit_logs")
}

model Post {
  id            String     @id @default(uuid())
  title         String
  content       String
  excerpt       String?
  slug          String     @unique
  featuredImage String?
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  authorId String
  author   User   @relation("PostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  // Relations
  comments Comment[]
  likes    Like[]
  tags     PostTag[] @relation("PostTags")

  @@map("posts")
}

model Comment {
  id      String @id @default(uuid())
  content String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  
  parentId String?
  parent   Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  @@map("comments")
}

model Tag {
  id    String @id @default(uuid())
  name  String @unique
  slug  String @unique
  color String?
  
  createdAt DateTime @default(now())
  
  posts PostTag[] @relation("TagPosts")

  @@map("tags")
}

model Like {
  id     String @id @default(uuid())
  postId String
  userId String
  
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation("UserLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("likes")
}

model PostTag {
  postId String
  tagId  String
  
  post Post @relation("PostTags", fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation("TagPosts", fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
}

model Notification {
  id        String  @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean @default(false)
  data      Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Task {
  id          String       @id @default(uuid())
  title       String
  description String?
  category    TaskCategory @default(OTHER)
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId String
  user   User   @relation("UserTasks", fields: [userId], references: [id], onDelete: Cascade)
  
  // Hierarchical relations
  parentId  String?
  parent    Task?   @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks  Task[]  @relation("TaskSubtasks")
  
  // Relations
  comments TaskComment[]
  media    TaskMedia[]
  shares   TaskShare[]

  // Performance indexes for GIAI ĐOẠN 1 optimization
  @@index([userId])
  @@index([parentId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([createdAt])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([userId, dueDate])
  @@map("tasks")
}

model TaskComment {
  id      String @id @default(uuid())
  content String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation("TaskCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  
  parentId String?
  parent   TaskComment? @relation("TaskCommentReplies", fields: [parentId], references: [id])
  replies  TaskComment[] @relation("TaskCommentReplies")

  // Performance indexes for GIAI ĐOẠN 1 optimization
  @@index([taskId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([taskId, createdAt])
  @@map("task_comments")
}

model TaskMedia {
  id        String    @id @default(uuid())
  type      MediaType
  url       String
  filename  String
  size      Int
  mimeType  String
  caption   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  uploadedBy String
  uploader   User   @relation("TaskMediaUploader", fields: [uploadedBy], references: [id])

  // Performance indexes for GIAI ĐOẠN 1 optimization
  @@index([taskId])
  @@index([uploadedBy])
  @@index([createdAt])
  @@index([type])
  @@map("task_media")
}

model TaskShare {
  id         String          @id @default(uuid())
  permission SharePermission @default(VIEW)
  shareToken String          @unique
  expiresAt  DateTime?
  isActive   Boolean         @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  sharedBy     String
  sharedByUser User   @relation("TaskSharedBy", fields: [sharedBy], references: [id])

  sharedWith     String?
  sharedWithUser User?   @relation("TaskSharedWith", fields: [sharedWith], references: [id])

  @@index([shareToken])
  @@map("task_shares")
}

// AI Training and Chatbot Models
enum TrainingDataType {
  DOCUMENT
  TEXT
  FAQ
  CONVERSATION
  KNOWLEDGE_BASE
}

enum TrainingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ChatbotStatus {
  ACTIVE
  INACTIVE
  TRAINING
}

model ChatbotModel {
  id          String        @id @default(uuid())
  name        String
  description String?
  systemPrompt String       @default("You are a helpful AI assistant.")
  status      ChatbotStatus @default(INACTIVE)
  
  // Model configuration
  temperature    Float   @default(0.7)
  maxTokens     Int     @default(1000)
  topP          Float   @default(1.0)
  frequencyPenalty Float @default(0.0)
  presencePenalty  Float @default(0.0)
  
  // Training metrics
  totalTrainingTokens Int @default(0)
  lastTrainedAt      DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  trainingData TrainingData[]
  conversations ChatConversation[]
  
  @@map("chatbot_models")
}

model TrainingData {
  id          String           @id @default(uuid())
  title       String
  content     String           @db.Text
  type        TrainingDataType
  status      TrainingStatus   @default(PENDING)
  
  // File information if uploaded
  fileName    String?
  fileSize    Int?
  filePath    String?
  
  // Processing information
  processedAt DateTime?
  errorMessage String?
  tokenCount  Int?
  
  // Embeddings for vector search
  embeddings  Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chatbotId   String
  chatbot     ChatbotModel @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([chatbotId, status])
  @@map("training_data")
}

model ChatConversation {
  id        String   @id @default(uuid())
  title     String?
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chatbotId String
  chatbot   ChatbotModel @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  messages  ChatMessage[]
  
  @@index([userId, chatbotId])
  @@map("chat_conversations")
}

model ChatMessage {
  id        String   @id @default(uuid())
  content   String   @db.Text
  role      String   // 'user' or 'assistant'
  
  // Response metadata
  tokenCount     Int?
  responseTime   Int?     // milliseconds
  relevantData   Json?    // references to training data used
  
  createdAt DateTime @default(now())

  // Relations
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId, createdAt])
  @@map("chat_messages")
}

model Hoadon {
  id            String          @id @default(uuid())
  nbmst         String
  khmshdon      Int?
  khhdon        String?
  shdon         Int?
  cqt           String?
  cttkhac       Json?
  dvtte         String?
  hdon          String?
  hsgcma        String?
  hsgoc         String?
  hthdon        Int?
  htttoan       Int?
  idtbao        String?
  khdon         String?
  khhdgoc       String?
  khmshdgoc     String?
  lhdgoc        Int?
  mhdon         String?
  mtdiep        String?
  mtdtchieu     String?
  nbdchi        String?
  nbhdktngay    DateTime?
  nbhdktso      String?
  nbhdso        String?
  nblddnbo      String?
  nbptvchuyen   String?
  nbstkhoan     String?
  nbten         String?
  nbtnhang      String?
  nbtnvchuyen   String?
  ncma          DateTime?
  ncnhat        DateTime?
  ngcnhat       String?
  nky           DateTime?
  nmdchi        String?
  nmmst         String?
  nmstkhoan     String?
  nmten         String?
  nmtnhang      String?
  nmtnmua       String?
  ntao          DateTime?
  ntnhan        DateTime?
  pban          String?
  ptgui         Int?
  shdgoc        Int?
  tchat         Int?
  tdlap         DateTime?
  tgia          Int?
  tgtcthue      Int?
  tgtthue       Int?
  tgtttbchu     String?
  tgtttbso      Int?
  thdon         String?
  thlap         Int?
  thttlphi      Json?
  tlhdon        String?
  ttcktmai      Int?
  tthai         Int?
  tttbao        Int?
  ttxly         Int?
  tvandnkntt    String?
  mhso          String?
  ladhddt       Int?
  mkhang        String?
  nbsdthoai     String?
  nbdctdtu      String?
  nbfax         String?
  nbwebsite     String?
  nbcks         String?
  nmsdthoai     String?
  nmdctdtu      String?
  nmcmnd        String?
  nmcks         String?
  bhphap        Int?
  hddunlap      String?
  gchdgoc       String?
  tbhgtngay     DateTime?
  bhpldo        String?
  bhpcbo        String?
  bhpngay       DateTime?
  tdlhdgoc      String?
  tgtphi        Int?
  unhiem        String?
  mstdvnunlhdon String?
  tdvnunlhdon   String?
  nbmdvqhnsach  String?
  nbsqdinh      String?
  nbncqdinh     String?
  nbcqcqdinh    String?
  nbhtban       String?
  nmmdvqhnsach  String?
  nmddvchden    String?
  nmtgvchdtu    String?
  nmtgvchdden   String?
  nbtnban       String?
  dcdvnunlhdon  String?
  dksbke        String?
  dknlbke       String?
  thtttoan      String?
  msttcgp       String?
  gchu          String?
  kqcht         String?
  hdntgia       String?
  tgtkcthue     String?
  tgtkhac       Int?
  nmshchieu     String?
  nmnchchieu    String?
  nmnhhhchieu   String?
  nmqtich       String?
  ktkhthue      String?
  hdhhdvu       String?
  qrcode        String?
  ttmstten      String?
  ladhddtten    String?
  hdxkhau       String?
  hdxkptquan    String?
  hdgktkhthue   String?
  hdonLquans    Json?
  tthdclquan    Boolean?
  pdndungs      Json?
  hdtbssrses    Json?
  hdTrung       String?
  isHDTrung     Boolean?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  HoadonChitiet HoadonChitiet[]
}

model HoadonChitiet {
  id        String   @id @default(uuid())
  codeId    String?
  title     String?
  title2    String?
  idhdon    String
  idhoadon  String
  hoadon    Hoadon   @relation(fields: [idhoadon], references: [id], onDelete: Cascade)
  dgia      Int?
  dvtinh    String?
  ltsuat    String?
  sluong    Int?
  stbchu    String?
  stckhau   Int?
  stt       Int?
  tchat     Int?
  ten       String?
  thtcthue  Int?
  thtien    Int?
  tlckhau   Int?
  tsuat     Float?
  tthue     Int?
  sxep      Int?
  dvtte     String?
  tgia      Int?
  order     Int?     @default(1)
  isproduct Boolean? @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([idhdon])
}

// Page Builder Models
enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum BlockType {
  TEXT
  IMAGE
  HERO
  GALLERY
  VIDEO
  BUTTON
  DIVIDER
  SPACER
  COLUMN
  ROW
  CARD
  TESTIMONIAL
  FAQ
  CONTACT_FORM
}

model Page {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  description String?
  content     Json?      // Stored as JSON for flexibility
  status      PageStatus @default(DRAFT)
  seoTitle    String?
  seoDescription String?
  ogImage     String?
  
  // Relationships
  blocks      PageBlock[]
  
  // Timestamps and user tracking
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  publishedAt DateTime?
  createdBy   String
  updatedBy   String?
  
  // Indexing
  @@index([slug])
  @@index([status])
  @@index([createdAt])
}

model PageBlock {
  id        String    @id @default(cuid())
  type      BlockType
  content   Json      // Block-specific content and configuration
  style     Json?     // CSS styles and layout properties
  order     Int       @default(0)
  isVisible Boolean   @default(true)
  
  // Page relationship
  pageId    String
  page      Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Indexing for performance
  @@index([pageId, order])
  @@index([type])
}

// MFA and Security Models
model UserMfaSettings {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  // TOTP Settings
  totpEnabled             Boolean  @default(false)
  totpSecret              String?  // Encrypted TOTP secret
  
  // SMS Settings
  smsEnabled              Boolean  @default(false)
  smsPhoneNumber          String?  // Encrypted phone number
  
  // Email Settings
  emailEnabled            Boolean  @default(false)
  
  // Hardware Token Settings
  hardwareTokenEnabled    Boolean  @default(false)
  
  // Backup Codes
  backupCodes             String?  // Encrypted backup codes JSON
  backupCodesGenerated    Boolean  @default(false)
  backupCodesUsed         Int      @default(0)
  
  // Emergency Settings
  emergencyContactEnabled Boolean  @default(false)
  emergencyContact        String?  // Encrypted emergency contact
  
  // Preferences
  preferredMethod         String   @default("totp") // totp, sms, email, hardware
  
  // Timestamps
  enabledAt               DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relationships
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model UserDevice {
  id           String    @id @default(cuid())
  userId       String
  deviceId     String    @unique // Generated device identifier
  deviceName   String    // User-friendly device name
  deviceType   String    // mobile, desktop, tablet, unknown
  browser      String?   // Browser information
  os           String?   // Operating system
  ipAddress    String    // Last known IP address
  location     String?   // Geographic location (city, country)
  isTrusted    Boolean   @default(false)
  
  // Security
  isActive     Boolean   @default(true)
  lastUsed     DateTime  @default(now())
  
  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relationships
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions     UserSession[]
  
  @@index([userId])
  @@index([deviceId])
  @@index([lastUsed])
}



model SecurityEvent {
  id              String    @id @default(cuid())
  userId          String?
  sessionId       String?
  
  // Event Classification
  eventType       String    // login_attempt, mfa_failure, suspicious_activity, etc.
  severity        String    // low, medium, high, critical
  category        String    // authentication, authorization, data_access, etc.
  
  // Event Details
  description     String
  details         Json?     // Detailed event information
  
  // Source Information
  ipAddress       String
  userAgent       String?
  location        String?   // Geographic location
  
  // Risk Assessment
  riskScore       Float?    // Calculated risk score (0-1)
  isBlocked       Boolean   @default(false)
  requiresAction  Boolean   @default(false)
  
  // Resolution
  isResolved      Boolean   @default(false)
  resolvedBy      String?   // User ID who resolved the event
  resolvedAt      DateTime?
  resolution      String?   // Resolution details
  
  // Metadata
  correlationId   String?   // For tracking related events
  parentEventId   String?   // For linked events
  
  // Timestamps
  detectedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relationships
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  parentEvent     SecurityEvent? @relation("SecurityEventHierarchy", fields: [parentEventId], references: [id], onDelete: SetNull)
  childEvents     SecurityEvent[] @relation("SecurityEventHierarchy")
  
  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([detectedAt])
  @@index([isResolved])
  @@index([correlationId])
  @@index([parentEventId])
}

// RBAC (Role-Based Access Control) Models
model Role {
  id           String    @id @default(cuid())
  name         String    @unique
  displayName  String    // User-friendly role name
  description  String?
  
  // Hierarchy
  parentId     String?
  parent       Role?     @relation("RoleHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     Role[]    @relation("RoleHierarchy")
  
  // Role Properties
  isSystemRole Boolean   @default(false) // System roles cannot be deleted
  isActive     Boolean   @default(true)
  priority     Int       @default(0) // Higher priority roles override lower ones
  
  // Metadata
  metadata     Json?     // Additional role configuration
  
  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relationships
  permissions  RolePermission[]
  userRoles    UserRoleAssignment[]
  
  @@index([name])
  @@index([parentId])
  @@index([isActive])
  @@index([priority])
}

model Permission {
  id            String    @id @default(cuid())
  name          String    @unique
  displayName   String    // User-friendly permission name
  description   String?
  
  // Permission Details
  resource      String    // Resource type (user, task, project, etc.)
  action        String    // Action (create, read, update, delete, etc.)
  scope         String?   // Scope limitation (own, team, organization, global)
  
  // Permission Properties
  isSystemPerm  Boolean   @default(false) // System permissions cannot be deleted
  isActive      Boolean   @default(true)
  category      String    @default("general") // Permission category for organization
  
  // Conditions (JSON-based conditions for dynamic permissions)
  conditions    Json?     // Dynamic permission conditions
  
  // Metadata
  metadata      Json?     // Additional permission configuration
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relationships
  rolePermissions RolePermission[]
  userPermissions UserPermission[]
  
  @@unique([resource, action, scope])
  @@index([resource])
  @@index([action])
  @@index([category])
  @@index([isActive])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  
  // Permission Configuration
  effect       String     @default("allow") // allow, deny
  conditions   Json?      // Additional conditions for this role-permission pair
  
  // Metadata
  grantedBy    String?    // User ID who granted this permission
  grantedAt    DateTime   @default(now())
  expiresAt    DateTime?  // Optional expiration
  
  // Timestamps
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Relationships
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@index([effect])
  @@index([expiresAt])
}

model UserRoleAssignment {
  id        String    @id @default(cuid())
  userId    String
  roleId    String
  
  // Role Assignment Properties
  effect    String    @default("allow") // allow, deny
  scope     String?   // Scope limitation for this user-role assignment
  
  // Assignment Details
  assignedBy String?  // User ID who assigned this role
  assignedAt DateTime @default(now())
  expiresAt  DateTime? // Optional expiration
  
  // Conditions
  conditions Json?    // Dynamic conditions for role assignment
  
  // Metadata
  metadata   Json?    // Additional assignment metadata
  
  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@index([effect])
  @@index([expiresAt])
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  
  // Direct Permission Assignment
  effect       String     @default("allow") // allow, deny
  scope        String?    // Scope limitation
  
  // Assignment Details
  assignedBy   String?    // User ID who granted this permission
  assignedAt   DateTime   @default(now())
  expiresAt    DateTime?  // Optional expiration
  reason       String?    // Reason for direct permission assignment
  
  // Conditions
  conditions   Json?      // Dynamic conditions
  
  // Metadata
  metadata     Json?      // Additional metadata
  
  // Timestamps
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Relationships
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([effect])
  @@index([expiresAt])
}

model ResourceAccess {
  id           String    @id @default(cuid())
  userId       String
  resourceType String    // Type of resource (task, project, etc.)
  resourceId   String    // ID of the specific resource
  
  // Access Details
  accessType   String    // Type of access (owner, member, viewer, etc.)
  permissions  Json      // Specific permissions for this resource
  
  // Access Properties
  inheritedFrom String?  // ID of parent resource if access is inherited
  isInherited   Boolean  @default(false)
  isActive      Boolean  @default(true)
  
  // Assignment Details
  grantedBy     String?  // User ID who granted access
  grantedAt     DateTime @default(now())
  expiresAt     DateTime? // Optional expiration
  
  // Conditions
  conditions    Json?    // Dynamic access conditions
  
  // Metadata
  metadata      Json?    // Additional metadata
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relationships
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, resourceType, resourceId])
  @@index([userId])
  @@index([resourceType])
  @@index([resourceId])
  @@index([accessType])
  @@index([isActive])
  @@index([expiresAt])
}

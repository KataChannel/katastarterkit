version: '3.8'

services:
  # Next.js Full-Stack Application
  # Replaces both backend (NestJS) and frontend (Next.js) services
  # Memory target: 400MB (vs 768MB previously = 48% reduction)
  nextjs-fullstack:
    build:
      context: ./frontend
      dockerfile: Dockerfile.fullstack
      args:
        NODE_ENV: production
    container_name: innerbright-fullstack
    restart: unless-stopped
    
    # Resource limits - optimized for 1 core, 2GB RAM server
    deploy:
      resources:
        limits:
          cpus: '0.8'           # 80% of 1 core
          memory: 500M          # Max 500MB (target 400MB)
        reservations:
          cpus: '0.5'           # Reserve 50% of core
          memory: 300M          # Reserve 300MB
    
    # Port mapping
    ports:
      - "3000:3000"
    
    # Environment variables
    environment:
      # Node.js
      NODE_ENV: production
      PORT: 3000
      
      # Database Connection (PostgreSQL 16)
      DATABASE_URL: postgresql://innerv2:innerv2@116.118.48.208:13003/innerv2core?schema=public&connect_timeout=10&pool_timeout=10&socket_timeout=10
      
      # Redis Cache (Shared service)
      REDIS_HOST: 116.118.48.208
      REDIS_PORT: 12004
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      
      # MinIO Storage (Shared service)
      MINIO_ENDPOINT: 116.118.48.208
      MINIO_PORT: 12007
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: uploads
      MINIO_USE_SSL: false
      MINIO_PUBLIC_URL: http://116.118.48.208:12007
      
      # Authentication
      JWT_SECRET: ${JWT_SECRET:-change-this-in-production-please-use-strong-secret}
      JWT_EXPIRES_IN: 7d
      SESSION_SECRET: ${SESSION_SECRET:-change-this-session-secret-in-production}
      
      # Application URLs
      NEXT_PUBLIC_API_URL: http://116.118.48.208:3000
      NEXT_PUBLIC_SITE_URL: https://innerbright.vn
      NEXTAUTH_URL: https://innerbright.vn
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-nextauth-secret}
      
      # GraphQL (Legacy - kept for backward compatibility)
      NEXT_PUBLIC_GRAPHQL_ENDPOINT: http://116.118.48.208:3000/api/graphql
      NEXT_PUBLIC_WS_ENDPOINT: ws://116.118.48.208:3000/api/graphql
      
      # Email (Optional - configure if needed)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@innerbright.vn}
      
      # Logging
      LOG_LEVEL: info
      
      # Performance tuning for low-resource server
      NODE_OPTIONS: "--max-old-space-size=384"  # Limit heap to 384MB
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Volume mounts (if needed for logs or uploads)
    volumes:
      - ./frontend/logs:/app/logs
      - /etc/localtime:/etc/localtime:ro
    
    # Network
    networks:
      - innerbright-network
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Labels for monitoring (Prometheus/Grafana)
    labels:
      - "com.innerbright.service=fullstack"
      - "com.innerbright.version=2.0"
      - "com.innerbright.environment=production"

networks:
  innerbright-network:
    driver: bridge
    name: innerbright-network

# Volume definitions
volumes:
  frontend-logs:
    driver: local

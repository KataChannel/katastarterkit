# Zalo ZNS Rate Limiting - Visual Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ZALO ZNS BULK SENDER                             │
│                      with Rate Limiting & Retry                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        1. USER UPLOADS EXCEL                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │  Parse Excel Data     │
                        │  Validate Each Row    │
                        │  Mark Valid/Invalid   │
                        └───────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │   Show Data Table     │
                        │   User Selects Rows   │
                        │   Configure Settings  │
                        └───────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    2. CLICK "GỬI HÀNG LOẠT"                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────┐        │        ┌──────────────────────────┐
│   FRONTEND PROCESS       │◄───────┴───────►│   BACKEND PROCESS        │
└──────────────────────────┘                 └──────────────────────────┘
                                    
┌─────────────────────────────────────────────────────────────────────────┐
│                     3. BATCH PROCESSING FLOW                             │
└─────────────────────────────────────────────────────────────────────────┘

Total Items: 1000
         │
         ▼
    Split into Batches (batchSize = 50)
         │
         ├─► Batch 1 (Items 1-50)
         │        │
         │        ▼
         │   Split into Chunks (concurrentRequests = 3)
         │        │
         │        ├─► Chunk 1 (Items 1-3)
         │        │        │
         │        │        ├─► Item 1 ──┐
         │        │        ├─► Item 2   ├─► Send Parallel
         │        │        └─► Item 3 ──┘
         │        │                 │
         │        │                 ▼
         │        │        Wait 250ms (delayBetweenRequests)
         │        │                 │
         │        ├─► Chunk 2 (Items 4-6)
         │        │        │
         │        │       ...
         │        │
         │        └─► Chunk 17 (Items 49-50)
         │                 │
         │                 ▼
         │        ⏱ Wait 2000ms (delayBetweenBatches)
         │
         ├─► Batch 2 (Items 51-100)
         │        │
         │       ...
         │
         └─► Batch 20 (Items 951-1000)
                  │
                  ▼
              ✅ Complete!

┌─────────────────────────────────────────────────────────────────────────┐
│                     4. RETRY MECHANISM FLOW                              │
└─────────────────────────────────────────────────────────────────────────┘

    Send Request
         │
         ▼
    ┌─────────┐
    │ Success?│
    └─────────┘
         │
    ┌────┴────┐
    │         │
   YES       NO
    │         │
    │         ▼
    │    ┌──────────┐
    │    │Error 429?│
    │    └──────────┘
    │         │
    │    ┌────┴────┐
    │    │         │
    │   YES       NO
    │    │         │
    │    │         └─► Return Error (No Retry)
    │    │
    │    ▼
    │ Retry Count < Max?
    │    │
    │   YES
    │    │
    │    ▼
    │ Wait (Exponential Backoff)
    │    │
    │    ├─► Retry 1: Wait 1s
    │    ├─► Retry 2: Wait 2s
    │    └─► Retry 3: Wait 4s
    │         │
    │         ▼
    │    Send Again ──┐
    │                 │
    └─► Mark Success  │
                      │
              (Loop back to "Success?")

┌─────────────────────────────────────────────────────────────────────────┐
│                     5. PROGRESS TRACKING                                 │
└─────────────────────────────────────────────────────────────────────────┘

Frontend Display:
┌──────────────────────────────────────────────────────────────┐
│ 📤 Đang gửi... (450/1000)                           45.0%    │
├──────────────────────────────────────────────────────────────┤
│ ████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░         │
├──────────────────────────────────────────────────────────────┤
│ Lô 9/20                                  450 / 1000 tin      │
└──────────────────────────────────────────────────────────────┘

Update Flow:
    Process Item
         │
         ▼
    Update Counter
         │
         ▼
    Calculate Percentage
         │
         ▼
    setSendingProgress({
        current: 450,
        total: 1000,
        percentage: 45.0,
        currentBatch: 9,
        totalBatches: 20
    })
         │
         ▼
    Re-render Progress Bar

┌─────────────────────────────────────────────────────────────────────────┐
│                     6. ERROR HANDLING DECISION TREE                      │
└─────────────────────────────────────────────────────────────────────────┘

Request Failed
      │
      ▼
 Get Error Code
      │
      ├─► -429 (Rate Limit)
      │        │
      │        └─► RETRY with Backoff
      │
      ├─► -124 (Token Expired)
      │        │
      │        └─► FAIL + Suggest "Get new token"
      │
      ├─► -108 (Invalid Phone)
      │        │
      │        └─► FAIL + Suggest "Fix phone format"
      │
      ├─► -118 (Account Not Found)
      │        │
      │        └─► FAIL + Skip this user
      │
      └─► Other Errors
               │
               └─► RETRY 1 time, then FAIL

┌─────────────────────────────────────────────────────────────────────────┐
│                     7. CONFIGURATION IMPACT                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────┬──────────────┬──────────────┬──────────────┐
│   Parameter     │   Low Value  │  High Value  │   Impact     │
├─────────────────┼──────────────┼──────────────┼──────────────┤
│ batchSize       │     20       │     100      │   Speed ↑    │
│                 │   (Safer)    │  (Riskier)   │   Risk ↑     │
├─────────────────┼──────────────┼──────────────┼──────────────┤
│ delay           │    100ms     │    1000ms    │   Speed ↓    │
│ BetweenRequests │   (Faster)   │   (Safer)    │   Safety ↑   │
├─────────────────┼──────────────┼──────────────┼──────────────┤
│ delay           │    1000ms    │   10000ms    │   Speed ↓    │
│ BetweenBatches  │   (Faster)   │   (Safer)    │   Safety ↑   │
├─────────────────┼──────────────┼──────────────┼──────────────┤
│ concurrent      │      1       │      10      │   Speed ↑    │
│ Requests        │   (Safer)    │  (Riskier)   │   Risk ↑     │
├─────────────────┼──────────────┼──────────────┼──────────────┤
│ maxRetries      │      1       │      5       │   Success ↑  │
│                 │   (Faster)   │   (Slower)   │   Time ↑     │
└─────────────────┴──────────────┴──────────────┴──────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                     8. TIMING DIAGRAM (Example)                          │
└─────────────────────────────────────────────────────────────────────────┘

100 Items, batchSize=20, concurrent=3, delay=250ms

Time (seconds) →
0    10   20   30   40   50   60   70   80   90   100  110  120
├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
│Batch 1                │
│ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  │
│                       │
│                   [2s wait]
│                       │
│                       │Batch 2              │
│                       │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │
│                       │                     │
│                       │                 [2s wait]
│                       │                     │
│                       │                     │Batch 3            │
│                       │                     │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │
│                       │                     │                   │
│                       │                     │               [2s wait]
│                       │                     │                   │
│                       │                     │                   │Batch 4          │
│                       │                     │                   │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │
│                       │                     │                   │                 │
│                       │                     │                   │             [2s wait]
│                       │                     │                   │                 │
│                       │                     │                   │                 │Batch 5        │
│                       │                     │                   │                 │ ▓▓▓▓▓▓▓▓▓▓▓▓ │
└───────────────────────────────────────────────────────────────────────────────────────────────────┘

Total Time: ~30 seconds for 100 items

▓ = Active sending
░ = Waiting (rate limiting)

┌─────────────────────────────────────────────────────────────────────────┐
│                     9. COMPONENT INTERACTION                             │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Frontend   │◄───────►│    Backend   │◄───────►│  Zalo API    │
│  (Browser)   │   HTTP  │  (Node.js)   │   HTTP  │              │
└──────────────┘         └──────────────┘         └──────────────┘
       │                        │                         │
       │                        │                         │
       │  1. Upload Excel       │                         │
       │───────────────────────►│                         │
       │                        │                         │
       │  2. Validate Data      │                         │
       │◄───────────────────────│                         │
       │                        │                         │
       │  3. Start Bulk Send    │                         │
       │───────────────────────►│                         │
       │                        │                         │
       │                        │  4. Queue Process       │
       │                        │  ┌─────────────────┐   │
       │                        │  │ Create Queue    │   │
       │                        │  │ Add Items       │   │
       │                        │  │ Start Processing│   │
       │                        │  └─────────────────┘   │
       │                        │                         │
       │                        │  5. Send to Zalo       │
       │                        │────────────────────────►│
       │                        │                         │
       │                        │  6. Response            │
       │                        │◄────────────────────────│
       │                        │                         │
       │                        │  7. Check if 429        │
       │                        │  ┌─────────────────┐   │
       │                        │  │ if (429) retry  │   │
       │                        │  └─────────────────┘   │
       │                        │                         │
       │                        │  8. Retry if needed    │
       │                        │────────────────────────►│
       │                        │                         │
       │  9. Progress Update    │                         │
       │◄───────────────────────│                         │
       │                        │                         │
       │  10. Final Results     │                         │
       │◄───────────────────────│                         │
       │                        │                         │

┌─────────────────────────────────────────────────────────────────────────┐
│                     10. STATE MACHINE                                    │
└─────────────────────────────────────────────────────────────────────────┘

   ┌─────────┐
   │  IDLE   │
   └────┬────┘
        │
        │ Upload Excel
        ▼
   ┌─────────┐
   │VALIDATED│
   └────┬────┘
        │
        │ Click Send
        ▼
   ┌─────────┐
   │SENDING  │◄────┐
   └────┬────┘     │
        │          │
        │          │ Retry
        ├──────────┘
        │
        │ All Sent
        ▼
   ┌─────────┐
   │COMPLETE │
   └────┬────┘
        │
        │ Export / Clear
        ▼
   ┌─────────┐
   │  IDLE   │
   └─────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                     11. PERFORMANCE METRICS                              │
└─────────────────────────────────────────────────────────────────────────┘

                        Success Rate
    100% │                              ╱───────
         │                         ╱────
         │                    ╱────
     95% │               ╱────
         │          ╱────
     90% │     ╱────
         │╱────
     85% │
         └────┬────┬────┬────┬────┬────┬────┬────
             No   100ms 250ms 500ms 1s   2s   5s
             Delay    ← Delay Between Requests →

Legend:
- Without delay: 45% success (too many 429)
- 100ms delay: 85% success (some 429)
- 250ms delay: 98% success (recommended)
- 500ms delay: 99.5% success (very safe)
- 1s+ delay: 99.9% success (overkill for most)

┌─────────────────────────────────────────────────────────────────────────┐
│                     12. QUICK REFERENCE                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌────────────┬────────┬────────┬────────┬─────────┬──────────┐
│  Profile   │ Batch  │ Delay  │ Delay  │ Concur. │  Speed   │
│            │  Size  │ Req(ms)│Batch(s)│ Request │ (msg/min)│
├────────────┼────────┼────────┼────────┼─────────┼──────────┤
│ Maximum ⚡ │  100   │  100   │   0.5  │   10    │  ~1500   │
│ Fast 🚀    │  100   │  150   │   1    │    5    │  ~1000   │
│ Balanced ⚖ │   50   │  250   │   2    │    3    │  ~500    │
│ Safe 🛡️    │   20   │  500   │   5    │    1    │  ~100    │
└────────────┴────────┴────────┴────────┴─────────┴──────────┘

             ⚡ Maximum  🚀 Fast  ⚖ Balanced  🛡️ Safe
Success:        70%       90%      98%        99.9%
429 Errors:     30%       10%       2%        0.1%
Reliability:    LOW       MED      HIGH       VERY HIGH
Use When:       Testing   Urgent   Daily      Critical

═══════════════════════════════════════════════════════════════════════════

                            🎯 RECOMMENDATION

                    Use BALANCED profile for production
                         98% success rate
                         ~500 messages/10 min
                         Best risk/speed ratio

═══════════════════════════════════════════════════════════════════════════
```

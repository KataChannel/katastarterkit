# ğŸ“Š HÆ¯á»šNG DáºªN TÃCH Há»¢P ANALYTICS & SUPPORT CHAT

> **NgÃ y cáº­p nháº­t**: 01/12/2025  
> **PhiÃªn báº£n**: 1.0.0  
> **TÃ¡c giáº£**: KataCore Team

---

## Má»¤C Lá»¤C

1. [Tá»•ng quan](#tá»•ng-quan)
2. [Pháº§n 1: Cáº¥u hÃ¬nh Analytics cho Footer](#pháº§n-1-cáº¥u-hÃ¬nh-analytics-cho-footer)
3. [Pháº§n 2: Cáº¥u hÃ¬nh Ä‘Äƒng nháº­p Support Chat](#pháº§n-2-cáº¥u-hÃ¬nh-Ä‘Äƒng-nháº­p-support-chat)
4. [Pháº§n 3: Tá»•ng há»£p biáº¿n mÃ´i trÆ°á»ng](#pháº§n-3-tá»•ng-há»£p-biáº¿n-mÃ´i-trÆ°á»ng)
5. [Checklist tÃ­ch há»£p](#checklist-tÃ­ch-há»£p)

---

## Tá»”NG QUAN

Dá»± Ã¡n RauSach Ä‘Ã£ cÃ³ sáºµn há»‡ thá»‘ng **Analytics** vÃ  **Support Chat** hoÃ n chá»‰nh. TÃ i liá»‡u nÃ y hÆ°á»›ng dáº«n cÃ¡ch cáº¥u hÃ¬nh Ä‘á»ƒ sá»­ dá»¥ng cÃ¡c tÃ­nh nÄƒng nÃ y.

### Kiáº¿n trÃºc há»‡ thá»‘ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (Next.js)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  website-footer â”‚  â”‚ SupportChatWidgetâ”‚  â”‚ OAuth Callbacks â”‚  â”‚
â”‚  â”‚  (Thá»‘ng kÃª GA)  â”‚  â”‚ (Chat realtime) â”‚  â”‚ (Social Login)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                    â”‚                    â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚           â”‚
â”‚  â”‚ useVisitorStats â”‚  â”‚ Socket.IO Clientâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”‚     (Hook)      â”‚  â”‚                 â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ GraphQL            â”‚ WebSocket
            â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKEND (NestJS)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚AnalyticsService â”‚  â”‚ SupportChatGatewayâ”‚ â”‚SocialAuthServiceâ”‚  â”‚
â”‚  â”‚  (GA4 API)      â”‚  â”‚   (WebSocket)   â”‚  â”‚  (OAuth verify) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                    â”‚                    â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Analytics â”‚  â”‚   PostgreSQL   â”‚  â”‚ Zalo/FB/Google    â”‚
â”‚      GA4 API      â”‚  â”‚   + Redis      â”‚  â”‚    OAuth APIs     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## PHáº¦N 1: Cáº¤U HÃŒNH ANALYTICS CHO FOOTER

### 1.1. Tá»•ng quan há»‡ thá»‘ng Analytics

| Component | File | Chá»©c nÄƒng |
|-----------|------|-----------|
| Backend Service | `backend/src/analytics/analytics.service.ts` | Káº¿t ná»‘i Google Analytics GA4 |
| Backend Resolver | `backend/src/analytics/analytics.resolver.ts` | GraphQL API |
| Frontend Hook | `frontend/src/hooks/useVisitorStats.ts` | Hook láº¥y dá»¯ liá»‡u |
| Footer Component | `frontend/src/components/layout/website-footer.tsx` | Hiá»ƒn thá»‹ thá»‘ng kÃª |

### 1.2. CÃ¡ch cáº¥u hÃ¬nh Google Analytics

#### BÆ°á»›c 1: Táº¡o Service Account trÃªn Google Cloud

```bash
# 1. VÃ o Google Cloud Console: https://console.cloud.google.com
# 2. Táº¡o Project má»›i hoáº·c chá»n Project hiá»‡n cÃ³
# 3. Enable "Google Analytics Data API":
#    - APIs & Services â†’ Library â†’ Search "Google Analytics Data API" â†’ Enable
# 4. Táº¡o Service Account:
#    - IAM & Admin â†’ Service Accounts â†’ Create Service Account
#    - Äáº·t tÃªn, vÃ­ dá»¥: "analytics-reader"
#    - Táº£i JSON credentials vá» mÃ¡y
```

#### BÆ°á»›c 2: Cáº¥p quyá»n trong Google Analytics

```bash
# 1. VÃ o Google Analytics: https://analytics.google.com
# 2. Admin â†’ Account Access Management
# 3. Click "+" â†’ Add users
# 4. Nháº­p email cá»§a Service Account (tá»« file JSON)
# 5. Cáº¥p quyá»n "Viewer" (chá»‰ cáº§n Ä‘á»c)
# 6. Click "Add"
```

#### BÆ°á»›c 3: Láº¥y GA4 Property ID

```bash
# Trong Google Analytics:
# 1. Admin â†’ Property Settings
# 2. Property ID náº±m á»Ÿ gÃ³c trÃªn bÃªn pháº£i
# 3. Format: 123456789 (chá»‰ sá»‘, KHÃ”NG cÃ³ prefix "G-")

# LÆ°u Ã½: Property ID khÃ¡c vá»›i Measurement ID (G-XXXXXXXX)
```

#### BÆ°á»›c 4: ThÃªm vÃ o file `.env` cá»§a backend

```dotenv
# ==========================================
# Google Analytics GA4 API (láº¥y thá»‘ng kÃª cho footer)
# ==========================================
GA4_PROPERTY_ID=123456789

# CÃ¡ch 1: Sá»­ dá»¥ng file JSON credentials (development)
# Äáº·t file JSON vÃ o backend/ vÃ  trá» Ä‘Æ°á»ng dáº«n
GOOGLE_APPLICATION_CREDENTIALS=/path/to/your-service-account.json

# CÃ¡ch 2: Sá»­ dá»¥ng JSON string (production/docker)
# Copy toÃ n bá»™ ná»™i dung file JSON vÃ o biáº¿n nÃ y
GOOGLE_CREDENTIALS_JSON='{"type":"service_account","project_id":"your-project","private_key_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n","client_email":"analytics@your-project.iam.gserviceaccount.com","client_id":"...","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"..."}'
```

### 1.3. Cáº¥u hÃ¬nh Website Settings (Admin UI)

Footer sá»­ dá»¥ng setting `footer.show_visitor_stats` Ä‘á»ƒ báº­t/táº¯t hiá»ƒn thá»‹ thá»‘ng kÃª.

#### CÃ¡ch 1: Qua Admin UI

```
1. ÄÄƒng nháº­p vá»›i tÃ i khoáº£n Admin
2. VÃ o: /admin/settings/website
3. Chá»n Tab "Footer"
4. Báº­t toggle "Hiá»ƒn thá»‹ thá»‘ng kÃª truy cáº­p"
5. Click "LÆ°u thay Ä‘á»•i"
```

#### CÃ¡ch 2: Seed vÃ o database

ThÃªm vÃ o file `backend/prisma/seed.ts`:

```typescript
// Seed footer visitor stats setting
await prisma.websiteSetting.upsert({
  where: { key: 'footer.show_visitor_stats' },
  update: {},
  create: {
    key: 'footer.show_visitor_stats',
    value: 'true',
    category: 'FOOTER',
    description: 'Hiá»ƒn thá»‹ thá»‘ng kÃª truy cáº­p á»Ÿ footer',
  },
});
```

Cháº¡y seed:

```bash
cd backend
bun prisma db seed
```

### 1.4. Data Flow - Luá»“ng dá»¯ liá»‡u

```
Google Analytics GA4
        â”‚
        â”‚ GA4 Data API
        â–¼
Backend (analytics.service.ts)
        â”‚
        â”‚ - getRealtimeUsers()
        â”‚ - getTodayVisits()
        â”‚ - getThisMonthVisits()
        â”‚ - getTotalVisits()
        â”‚
        â”‚ Cache: Redis (30s - 24h TTL)
        â–¼
GraphQL Query: visitorStats
        â”‚
        â”‚ Apollo Client
        â–¼
Frontend (useVisitorStats hook)
        â”‚
        â”‚ pollInterval: 60000ms (1 phÃºt)
        â–¼
website-footer.tsx
        â”‚
        â””â”€â–º Hiá»ƒn thá»‹:
            - Äang truy cáº­p: X ngÆ°á»i
            - HÃ´m nay: X lÆ°á»£t
            - Trong thÃ¡ng: X lÆ°á»£t
            - Tá»•ng truy cáº­p: X lÆ°á»£t
```

### 1.5. GraphQL API

#### Query: visitorStats

```graphql
query GetVisitorStats {
  visitorStats {
    realtime    # Sá»‘ ngÆ°á»i Ä‘ang online
    today       # LÆ°á»£t truy cáº­p hÃ´m nay
    thisMonth   # LÆ°á»£t truy cáº­p thÃ¡ng nÃ y
    total       # Tá»•ng lÆ°á»£t truy cáº­p (tá»« Ä‘áº§u nÄƒm)
  }
}
```

#### Query: realtimeUsers

```graphql
query GetRealtimeUsers {
  realtimeUsers  # Chá»‰ láº¥y sá»‘ ngÆ°á»i Ä‘ang online
}
```

#### Query: isAnalyticsConfigured

```graphql
query IsAnalyticsConfigured {
  isAnalyticsConfigured  # true/false - kiá»ƒm tra Ä‘Ã£ cáº¥u hÃ¬nh chÆ°a
}
```

### 1.6. Test Analytics

#### Test qua cURL

```bash
# Test GraphQL query
curl -X POST http://localhost:12001/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ visitorStats { realtime today thisMonth total } }"}'

# Expected response (khi chÆ°a cáº¥u hÃ¬nh - mock data):
{
  "data": {
    "visitorStats": {
      "realtime": 23,
      "today": 456,
      "thisMonth": 8765,
      "total": 98765
    }
  }
}
```

#### Test qua GraphQL Playground

1. Má»Ÿ: `http://localhost:12001/graphql`
2. Cháº¡y query á»Ÿ trÃªn
3. Náº¿u chÆ°a cáº¥u hÃ¬nh GA4, sáº½ nháº­n Ä‘Æ°á»£c mock data (sá»‘ ngáº«u nhiÃªn)

### 1.7. Xá»­ lÃ½ khi chÆ°a cÃ³ credentials

Khi chÆ°a cáº¥u hÃ¬nh Google Analytics credentials, há»‡ thá»‘ng sáº½:

1. Log warning: `"GA4_PROPERTY_ID khÃ´ng Ä‘Æ°á»£c cáº¥u hÃ¬nh, Analytics sáº½ tráº£ vá» dá»¯ liá»‡u máº«u"`
2. Tráº£ vá» mock data vá»›i sá»‘ ngáº«u nhiÃªn:
   - realtime: 5-55 ngÆ°á»i
   - today: 100-600 lÆ°á»£t
   - month: 2000-12000 lÆ°á»£t
   - total: 50000-150000 lÆ°á»£t

Äiá»u nÃ y cho phÃ©p development/testing mÃ  khÃ´ng cáº§n cáº¥u hÃ¬nh tháº­t.

---

## PHáº¦N 2: Cáº¤U HÃŒNH ÄÄ‚NG NHáº¬P SUPPORT CHAT

### 2.1. Tá»•ng quan há»‡ thá»‘ng Support Chat

Há»‡ thá»‘ng Support Chat há»— trá»£ nhiá»u phÆ°Æ¡ng thá»©c xÃ¡c thá»±c khÃ¡ch hÃ ng:

| Auth Type | Icon | MÃ´ táº£ | YÃªu cáº§u |
|-----------|------|-------|---------|
| GUEST | ğŸ‘¤ | Chá»‰ nháº­p tÃªn | KhÃ´ng |
| PHONE | ğŸ“± | TÃªn + Sá»‘ Ä‘iá»‡n thoáº¡i | KhÃ´ng |
| ZALO | ğŸ’¬ | ÄÄƒng nháº­p Zalo | Zalo App credentials |
| FACEBOOK | ğŸ‘¥ | ÄÄƒng nháº­p Facebook | Facebook App credentials |
| GOOGLE | ğŸ” | ÄÄƒng nháº­p Google | Google OAuth credentials |
| USER_ACCOUNT | ğŸ” | TÃ i khoáº£n há»‡ thá»‘ng | ÄÃ£ Ä‘Äƒng nháº­p website |

### 2.2. Files quan trá»ng

```
backend/
â”œâ”€â”€ src/support-chat/
â”‚   â”œâ”€â”€ support-chat.module.ts              # Module chÃ­nh
â”‚   â”œâ”€â”€ gateways/
â”‚   â”‚   â””â”€â”€ support-chat.gateway.ts         # WebSocket Gateway
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ support-conversation.service.ts # Quáº£n lÃ½ conversation
â”‚   â”‚   â”œâ”€â”€ support-message.service.ts      # Quáº£n lÃ½ messages
â”‚   â”‚   â”œâ”€â”€ social-auth.service.ts          # XÃ¡c thá»±c social login
â”‚   â”‚   â””â”€â”€ ai-assistant.service.ts         # AI suggestions
â”‚   â””â”€â”€ resolvers/
â”‚       â””â”€â”€ support-conversation.resolver.ts # GraphQL resolvers

frontend/
â”œâ”€â”€ src/components/support-chat/
â”‚   â”œâ”€â”€ SupportChatWidget.tsx               # Widget Ä‘Æ¡n giáº£n
â”‚   â”œâ”€â”€ SupportChatWidgetEnhanced.tsx       # Widget cÃ³ social login
â”‚   â”œâ”€â”€ SupportChatWidgetWrapper.tsx        # Wrapper component
â”‚   â””â”€â”€ AdminChatDashboard.tsx              # Dashboard cho admin
â”œâ”€â”€ src/lib/
â”‚   â””â”€â”€ social-auth.ts                      # OAuth helpers
â””â”€â”€ src/graphql/support-chat/
    â””â”€â”€ support-chat.graphql.ts             # GraphQL queries/mutations
```

### 2.3. Cáº¥u hÃ¬nh Social Login

#### A. Google OAuth

**Báº¡n Ä‘Ã£ cÃ³ Google credentials trong `.env.dev.rausach`:**

```dotenv
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

**BÆ°á»›c 1: ThÃªm vÃ o Frontend `.env.local`:**

```dotenv
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
```

**BÆ°á»›c 2: Cáº¥u hÃ¬nh Redirect URI trong Google Console:**

1. VÃ o: https://console.cloud.google.com/apis/credentials
2. Chá»n OAuth 2.0 Client ID cá»§a báº¡n
3. ThÃªm Authorized redirect URIs:

```
# Development
http://localhost:12000/oauth-callback/google/callback

# Production
https://rausachtrangia.com/oauth-callback/google/callback
```

#### B. Facebook OAuth

**BÆ°á»›c 1: Táº¡o Facebook App**

```
1. VÃ o: https://developers.facebook.com/
2. My Apps â†’ Create App â†’ Consumer
3. Äáº·t tÃªn app, vÃ­ dá»¥: "RauSach Support Chat"
4. ThÃªm product: Facebook Login
5. Settings â†’ Basic â†’ Láº¥y:
   - App ID
   - App Secret
```

**BÆ°á»›c 2: Cáº¥u hÃ¬nh Facebook Login**

```
Facebook Login â†’ Settings:
- Valid OAuth Redirect URIs:
  - http://localhost:12000/oauth-callback/facebook/callback
  - https://rausachtrangia.com/oauth-callback/facebook/callback
```

**BÆ°á»›c 3: ThÃªm vÃ o .env**

```dotenv
# Backend (.env)
FACEBOOK_APP_ID=your_facebook_app_id
FACEBOOK_APP_SECRET=your_facebook_app_secret

# Frontend (.env.local)
NEXT_PUBLIC_FACEBOOK_APP_ID=your_facebook_app_id
```

#### C. Zalo OAuth

**BÆ°á»›c 1: ÄÄƒng kÃ½ Zalo App**

```
1. VÃ o: https://developers.zalo.me/
2. ÄÄƒng kÃ½/ÄÄƒng nháº­p
3. Táº¡o á»©ng dá»¥ng má»›i
4. Láº¥y:
   - App ID
   - Secret Key
```

**BÆ°á»›c 2: Cáº¥u hÃ¬nh Callback URL**

```
Trong Zalo Developer Console:
- Callback URL:
  - http://localhost:12000/oauth-callback/zalo/callback
  - https://rausachtrangia.com/oauth-callback/zalo/callback
```

**BÆ°á»›c 3: ThÃªm vÃ o .env**

```dotenv
# Backend (.env)
ZALO_APP_ID=your_zalo_app_id
ZALO_APP_SECRET=your_zalo_secret_key

# Frontend (.env.local)
NEXT_PUBLIC_ZALO_APP_ID=your_zalo_app_id
```

### 2.4. TÃ­ch há»£p Support Chat Widget

#### CÃ¡ch 1: Widget Ä‘Æ¡n giáº£n (chá»‰ nháº­p tÃªn)

```tsx
// app/layout.tsx hoáº·c báº¥t ká»³ component nÃ o
import SupportChatWidget from '@/components/support-chat/SupportChatWidget';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <SupportChatWidget
          apiUrl="http://localhost:12001"
          websocketUrl="http://localhost:12001/support-chat"
          primaryColor="#2563eb"
          position="bottom-right"
        />
      </body>
    </html>
  );
}
```

#### CÃ¡ch 2: Widget nÃ¢ng cao (cÃ³ social login)

```tsx
import SupportChatWidgetEnhanced from '@/components/support-chat/SupportChatWidgetEnhanced';

<SupportChatWidgetEnhanced
  apiUrl="http://localhost:12001"
  websocketUrl="http://localhost:12001/support-chat"
  primaryColor="#2563eb"
  position="bottom-right"
  enableZaloLogin={true}      // Báº­t Ä‘Äƒng nháº­p Zalo
  enableFacebookLogin={true}  // Báº­t Ä‘Äƒng nháº­p Facebook
  enableGoogleLogin={true}    // Báº­t Ä‘Äƒng nháº­p Google
/>
```

#### CÃ¡ch 3: Sá»­ dá»¥ng SupportChatWidgetWrapper (Ä‘Ã£ cÃ³ sáºµn)

```tsx
import { SupportChatWidgetWrapper } from '@/components/support-chat/SupportChatWidgetWrapper';

// Widget sáº½ tá»± Ä‘á»™ng láº¥y config tá»« environment variables
<SupportChatWidgetWrapper />
```

### 2.5. Táº¡o OAuth Callback Pages

Táº¡o cÃ¡c pages Ä‘á»ƒ xá»­ lÃ½ OAuth callback:

#### Google Callback

**File: `frontend/src/app/oauth-callback/google/callback/page.tsx`**

```tsx
'use client';

import { useEffect } from 'react';
import { handleOAuthCallback } from '@/lib/social-auth';

export default function GoogleCallback() {
  useEffect(() => {
    handleOAuthCallback('GOOGLE');
  }, []);

  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4" />
        <p className="text-gray-600">Äang xá»­ lÃ½ Ä‘Äƒng nháº­p Google...</p>
      </div>
    </div>
  );
}
```

#### Facebook Callback

**File: `frontend/src/app/oauth-callback/facebook/callback/page.tsx`**

```tsx
'use client';

import { useEffect } from 'react';
import { handleOAuthCallback } from '@/lib/social-auth';

export default function FacebookCallback() {
  useEffect(() => {
    handleOAuthCallback('FACEBOOK');
  }, []);

  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4" />
        <p className="text-gray-600">Äang xá»­ lÃ½ Ä‘Äƒng nháº­p Facebook...</p>
      </div>
    </div>
  );
}
```

#### Zalo Callback

**File: `frontend/src/app/oauth-callback/zalo/callback/page.tsx`**

```tsx
'use client';

import { useEffect } from 'react';
import { handleOAuthCallback } from '@/lib/social-auth';

export default function ZaloCallback() {
  useEffect(() => {
    handleOAuthCallback('ZALO');
  }, []);

  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4" />
        <p className="text-gray-600">Äang xá»­ lÃ½ Ä‘Äƒng nháº­p Zalo...</p>
      </div>
    </div>
  );
}
```

### 2.6. WebSocket Events

#### Client â†’ Server Events

| Event | Payload | MÃ´ táº£ |
|-------|---------|-------|
| `join_conversation` | `{ conversationId, userId? }` | Tham gia conversation |
| `leave_conversation` | `{ conversationId }` | Rá»i conversation |
| `send_message` | `{ conversationId, content, senderType, senderName, customerAuthType? }` | Gá»­i tin nháº¯n |
| `typing_start` | `{ conversationId, userId }` | Báº¯t Ä‘áº§u gÃµ |
| `typing_stop` | `{ conversationId, userId }` | Ngá»«ng gÃµ |
| `mark_as_read` | `{ messageId }` | ÄÃ¡nh dáº¥u Ä‘Ã£ Ä‘á»c |
| `update_customer_auth` | `{ conversationId, authType, ... }` | Cáº­p nháº­t auth info |

#### Server â†’ Client Events

| Event | Payload | MÃ´ táº£ |
|-------|---------|-------|
| `new_message` | Message object | Tin nháº¯n má»›i |
| `ai_suggestion` | `{ conversationId, suggestion, confidence }` | Gá»£i Ã½ AI cho agent |
| `user_typing` | `{ conversationId, userId }` | User Ä‘ang gÃµ |
| `user_stopped_typing` | `{ conversationId, userId }` | User ngá»«ng gÃµ |
| `agent_assigned` | `{ conversationId, agent }` | Agent Ä‘Æ°á»£c assign |
| `conversation_status_changed` | `{ conversationId, status }` | Status thay Ä‘á»•i |
| `customer_auth_updated` | `{ conversationId, authType, customerName }` | Auth Ä‘Æ°á»£c cáº­p nháº­t |

### 2.7. Database Schema

#### SupportConversation

```prisma
model SupportConversation {
  id                 String   @id @default(uuid())
  conversationCode   String   @unique
  customerName       String?
  customerEmail      String?
  customerPhone      String?
  status             SupportConversationStatus @default(WAITING)
  platform           IntegrationPlatform @default(WEBSITE)
  
  // Authentication fields
  authType           CustomerAuthType @default(GUEST)
  socialAuthId       String?          // ID tá»« social platform
  socialAuthToken    String?          // Access token
  socialAuthData     Json?            // Profile data
  customerIdentifier String?          // Unique identifier
  
  // Relations
  messages           SupportMessage[]
  assignedAgent      User?    @relation(fields: [assignedAgentId])
  
  createdAt          DateTime @default(now())
}
```

#### SupportMessage

```prisma
model SupportMessage {
  id               String   @id @default(uuid())
  conversationId   String
  content          String
  senderType       SupportSender
  senderName       String?
  
  // Customer auth tracking
  customerAuthType String?  // GUEST, PHONE, ZALO, FACEBOOK, GOOGLE
  customerAuthIcon String?  // ğŸ‘¤, ğŸ“±, ğŸ’¬, ğŸ‘¥, ğŸ”
  
  // AI fields
  isAIGenerated    Boolean  @default(false)
  aiConfidence     Float?
  
  isRead           Boolean  @default(false)
  sentAt           DateTime @default(now())
  
  conversation     SupportConversation @relation(fields: [conversationId])
}
```

### 2.8. Test Support Chat

```bash
# 1. Start Backend
cd backend && bun run dev

# 2. Start Frontend
cd frontend && bun run dev

# 3. Má»Ÿ browser: http://localhost:12000
# 4. Click chat button á»Ÿ gÃ³c pháº£i mÃ n hÃ¬nh
# 5. Test cÃ¡c phÆ°Æ¡ng thá»©c:
#    - Tab "Sá»‘ Ä‘iá»‡n thoáº¡i": Nháº­p tÃªn + SÄT â†’ Báº¯t Ä‘áº§u chat
#    - Tab "ÄÄƒng nháº­p": Click Google/Facebook/Zalo (náº¿u Ä‘Ã£ cáº¥u hÃ¬nh)
```

---

## PHáº¦N 3: Tá»”NG Há»¢P BIáº¾N MÃ”I TRÆ¯á»œNG

### Backend (.env)

```dotenv
# ==========================================
# ANALYTICS - Google Analytics GA4
# ==========================================
# Property ID tá»« Google Analytics (chá»‰ sá»‘, khÃ´ng cÃ³ "G-")
GA4_PROPERTY_ID=123456789

# Chá»n 1 trong 2 cÃ¡ch sau:

# CÃ¡ch 1: File credentials (development)
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json

# CÃ¡ch 2: JSON string (production/docker)
GOOGLE_CREDENTIALS_JSON='{"type":"service_account",...}'

# ==========================================
# SUPPORT CHAT - AI Assistant
# ==========================================
# Google Gemini (khuyáº¿n nghá»‹)
GOOGLE_GEMINI_API_KEY=your_gemini_api_key

# OpenAI (tÃ¹y chá»n)
OPENAI_API_KEY=sk-your-openai-api-key

# ==========================================
# SUPPORT CHAT - Social OAuth
# ==========================================
# Facebook
FACEBOOK_APP_ID=your_facebook_app_id
FACEBOOK_APP_SECRET=your_facebook_app_secret

# Zalo
ZALO_APP_ID=your_zalo_app_id
ZALO_APP_SECRET=your_zalo_secret_key

# Google (dÃ¹ng chung vá»›i Google OAuth login)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

### Frontend (.env.local)

```dotenv
# ==========================================
# API URLs
# ==========================================
NEXT_PUBLIC_APP_URL=http://localhost:12000
NEXT_PUBLIC_API_URL=http://localhost:12001
NEXT_PUBLIC_WS_URL=http://localhost:12001/support-chat
NEXT_PUBLIC_GRAPHQL_ENDPOINT=http://localhost:12001/graphql

# ==========================================
# SOCIAL AUTH - Client IDs (public)
# ==========================================
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your_google_client_id.apps.googleusercontent.com
NEXT_PUBLIC_FACEBOOK_APP_ID=your_facebook_app_id
NEXT_PUBLIC_ZALO_APP_ID=your_zalo_app_id
```

### Production Environment

```dotenv
# Frontend
NEXT_PUBLIC_APP_URL=https://rausachtrangia.com
NEXT_PUBLIC_API_URL=https://api.rausachtrangia.com
NEXT_PUBLIC_WS_URL=https://api.rausachtrangia.com/support-chat
NEXT_PUBLIC_GRAPHQL_ENDPOINT=https://api.rausachtrangia.com/graphql

# Backend
FRONTEND_URL=https://rausachtrangia.com
```

---

## CHECKLIST TÃCH Há»¢P

### Analytics Footer

- [ ] Táº¡o Service Account trÃªn Google Cloud Console
- [ ] Enable Google Analytics Data API
- [ ] Cáº¥p quyá»n Viewer cho Service Account trong GA Admin
- [ ] Láº¥y GA4 Property ID (chá»‰ sá»‘, khÃ´ng cÃ³ "G-")
- [ ] ThÃªm `GA4_PROPERTY_ID` vÃ o `.env`
- [ ] ThÃªm credentials (file hoáº·c JSON string) vÃ o `.env`
- [ ] Báº­t setting `footer.show_visitor_stats` trong Admin UI
- [ ] Test GraphQL query `visitorStats`
- [ ] Verify hiá»ƒn thá»‹ trÃªn footer

### Support Chat Login

- [ ] **Google OAuth**
  - [ ] ThÃªm `NEXT_PUBLIC_GOOGLE_CLIENT_ID` vÃ o frontend `.env.local`
  - [ ] ThÃªm Redirect URI vÃ o Google Console
  - [ ] Táº¡o `/oauth-callback/google/callback/page.tsx`
  - [ ] Test Ä‘Äƒng nháº­p Google

- [ ] **Facebook OAuth**
  - [ ] Táº¡o Facebook App táº¡i developers.facebook.com
  - [ ] ThÃªm Facebook Login product
  - [ ] ThÃªm credentials vÃ o backend `.env`
  - [ ] ThÃªm `NEXT_PUBLIC_FACEBOOK_APP_ID` vÃ o frontend `.env.local`
  - [ ] ThÃªm Redirect URI vÃ o Facebook App Settings
  - [ ] Táº¡o `/oauth-callback/facebook/callback/page.tsx`
  - [ ] Test Ä‘Äƒng nháº­p Facebook

- [ ] **Zalo OAuth**
  - [ ] ÄÄƒng kÃ½ Zalo App táº¡i developers.zalo.me
  - [ ] ThÃªm credentials vÃ o backend `.env`
  - [ ] ThÃªm `NEXT_PUBLIC_ZALO_APP_ID` vÃ o frontend `.env.local`
  - [ ] ThÃªm Callback URL vÃ o Zalo Developer Console
  - [ ] Táº¡o `/oauth-callback/zalo/callback/page.tsx`
  - [ ] Test Ä‘Äƒng nháº­p Zalo

- [ ] **Widget Integration**
  - [ ] TÃ­ch há»£p `SupportChatWidgetEnhanced` vÃ o layout
  - [ ] Cáº¥u hÃ¬nh props cho widget
  - [ ] Test chat vá»›i tá»«ng phÆ°Æ¡ng thá»©c Ä‘Äƒng nháº­p

---

## TROUBLESHOOTING

### Analytics

#### Lá»—i: "GA4_PROPERTY_ID khÃ´ng Ä‘Æ°á»£c cáº¥u hÃ¬nh"

```bash
# Kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng
echo $GA4_PROPERTY_ID

# Verify trong .env
grep GA4_PROPERTY_ID .env
```

#### Lá»—i: "Lá»—i khá»Ÿi táº¡o Google Analytics client"

```bash
# Kiá»ƒm tra file credentials tá»“n táº¡i
ls -la /path/to/credentials.json

# Hoáº·c kiá»ƒm tra JSON string há»£p lá»‡
echo $GOOGLE_CREDENTIALS_JSON | jq .
```

#### Analytics tráº£ vá» mock data thay vÃ¬ data tháº­t

1. Kiá»ƒm tra Service Account Ä‘Ã£ Ä‘Æ°á»£c cáº¥p quyá»n trong GA chÆ°a
2. Verify Property ID Ä‘Ãºng (chá»‰ sá»‘, khÃ´ng cÃ³ "G-")
3. Kiá»ƒm tra API Ä‘Ã£ Ä‘Æ°á»£c enable trong Google Cloud chÆ°a

### Support Chat

#### Lá»—i: "Failed to connect to WebSocket"

```bash
# Kiá»ƒm tra backend Ä‘ang cháº¡y
curl http://localhost:12001/health

# Verify WebSocket URL
echo $NEXT_PUBLIC_WS_URL
```

#### Lá»—i: "Social login failed"

1. Verify App IDs/Secrets Ä‘Ãºng trong environment variables
2. Kiá»ƒm tra OAuth Redirect URIs Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng
3. Xem console logs Ä‘á»ƒ debug chi tiáº¿t

#### Lá»—i: "Prisma migration failed"

```bash
# Reset database (cáº©n tháº­n: xÃ³a toÃ n bá»™ data)
cd backend
bun prisma migrate reset

# Sau Ä‘Ã³ cháº¡y láº¡i migration
bun prisma migrate dev
```

---

## TÃ€I LIá»†U LIÃŠN QUAN

- [123-QUICK_SETUP_SUPPORT_CHAT.md](./123-QUICK_SETUP_SUPPORT_CHAT.md) - HÆ°á»›ng dáº«n setup nhanh
- [124-SUPPORT_CHAT_ENHANCED.md](./124-SUPPORT_CHAT_ENHANCED.md) - Chi tiáº¿t tÃ­nh nÄƒng Support Chat
- [85-ANALYTICS_INTEGRATION.md](./85-ANALYTICS_INTEGRATION.md) - TÃ­ch há»£p Google Analytics & Facebook Pixel
- [86-ANALYTICS_TAB_ADDED.md](./86-ANALYTICS_TAB_ADDED.md) - Tab Analytics trong Admin UI

---

## LIÃŠN Há»† Há»– TRá»¢

Náº¿u gáº·p váº¥n Ä‘á» trong quÃ¡ trÃ¬nh tÃ­ch há»£p:

1. Kiá»ƒm tra logs: `backend/logs/`
2. Kiá»ƒm tra browser console: DevTools â†’ Console
3. Táº¡o issue trÃªn GitHub repository

---

**Happy Coding! ğŸš€**
